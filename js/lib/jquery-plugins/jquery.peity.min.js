// (c) 2011 Ben Pickles

// Released under MIT license.

!function(t,e){function i(t,i){var a=e.createElement("canvas");return a.setAttribute("width",t*n),a.setAttribute("height",i*n),1!=n&&a.setAttribute("style","width:"+t+"px;height:"+i+"px"),a}var a=t.fn.peity=function(i,n){return e.createElement("canvas").getContext&&this.each(function(){t(this).change(function(){var e=t.extend({},n),h=this;t.each(e,function(i,a){t.isFunction(a)&&(e[i]=a.call(h))});var l=t(this).html();a.graphers[i].call(this,t.extend({},a.defaults[i],e)),t(this).trigger("chart:changed",l)}).trigger("change")}),this};a.graphers={},a.defaults={},a.add=function(t,e,i){a.graphers[t]=i,a.defaults[t]=e};var n=window.devicePixelRatio||1;a.add("pie",{colours:["#FFF4DD","#FF9900"],delimeter:"/",diameter:16},function(e){var a=t(this),n=a.text().split(e.delimeter),h=parseFloat(n[0]),l=parseFloat(n[1]),n=-Math.PI/2,h=h/l*Math.PI*2,l=i(e.diameter,e.diameter),r=l.getContext("2d"),o=l.width/2;r.beginPath(),r.moveTo(o,o),r.arc(o,o,o,h+n,0==h?2*Math.PI:n,!1),r.fillStyle=e.colours[0],r.fill(),r.beginPath(),r.moveTo(o,o),r.arc(o,o,o,n,h+n,!1),r.fillStyle=e.colours[1],r.fill(),a.wrapInner(t("<span>").hide()).append(l)}),a.add("line",{colour:"#c6d9fd",strokeColour:"#4d89f9",strokeWidth:1,delimeter:",",height:16,max:null,min:0,width:32},function(e){var a=t(this),h=i(e.width,e.height),l=a.text().split(e.delimeter);1==l.length&&l.push(l[0]);var r,o=Math.max.apply(Math,l.concat([e.max])),d=Math.min.apply(Math,l.concat([e.min])),c=h.getContext("2d"),s=h.width,p=h.height,u=s/(l.length-1),o=p/(o-d),g=[];for(c.beginPath(),c.moveTo(0,p+d*o),r=0;r<l.length;r++){var m=r*u,f=p-o*(l[r]-d);g.push({x:m,y:f}),c.lineTo(m,f)}if(c.lineTo(s,p+d*o),c.fillStyle=e.colour,c.fill(),e.strokeWidth){for(c.beginPath(),c.moveTo(0,g[0].y),r=0;r<g.length;r++)c.lineTo(g[r].x,g[r].y);c.lineWidth=e.strokeWidth*n,c.strokeStyle=e.strokeColour,c.stroke()}a.wrapInner(t("<span>").hide()).append(h)}),a.add("bar",{colour:"#4D89F9",delimeter:",",height:16,max:null,min:0,width:32},function(e){var a=t(this),h=a.text().split(e.delimeter),l=Math.max.apply(Math,h.concat([e.max])),r=Math.min.apply(Math,h.concat([e.min])),o=i(e.width,e.height),d=o.getContext("2d"),c=o.height,l=c/(l-r),s=n/2,p=(o.width+s)/h.length;for(d.fillStyle=e.colour,e=0;e<h.length;e++)d.fillRect(e*p,c-l*(h[e]-r),p-s,l*h[e]);a.wrapInner(t("<span>").hide()).append(o)})}(jQuery,document);