!function(e){e.fn.ligerFilter=function(){return e.ligerui.run.call(this,"ligerFilter",arguments)},e.fn.ligerGetFilterManager=function(){return e.ligerui.run.call(this,"ligerGetFilterManager",arguments)},e.ligerDefaults.Filter={fields:[],operators:{},editors:{},buttonCls:null},e.ligerDefaults.FilterString={strings:{and:"并且",or:"或者",equal:"相等",notequal:"不相等",startwith:"以..开始",endwith:"以..结束",like:"相似",greater:"大于",greaterorequal:"大于或等于",less:"小于",lessorequal:"小于或等于",in:"包括在...",notin:"不包括...",addgroup:"增加分组",addrule:"增加条件",deletegroup:"删除分组"}},e.ligerDefaults.Filter.operators.string=e.ligerDefaults.Filter.operators.text=["equal","notequal","startwith","endwith","like","greater","greaterorequal","less","lessorequal","in","notin"],e.ligerDefaults.Filter.operators.number=e.ligerDefaults.Filter.operators.int=e.ligerDefaults.Filter.operators.float=e.ligerDefaults.Filter.operators.date=["equal","notequal","greater","greaterorequal","less","lessorequal","in","notin"],e.ligerDefaults.Filter.editors.string={create:function(t,r){var i=e("<input type='text'/>");return t.append(i),i.ligerTextBox(r.editor.options||{}),i},setValue:function(e,t){e.val(t)},getValue:function(e){return e.liger("option","value")},destroy:function(e){e.liger("destroy")}},e.ligerDefaults.Filter.editors.date={create:function(t,r){var i=e("<input type='text'/>");return t.append(i),i.ligerDateEditor(r.editor.options||{}),i},setValue:function(e,t){e.liger("option","value",t)},getValue:function(e,t){return e.liger("option","value")},destroy:function(e){e.liger("destroy")}},e.ligerDefaults.Filter.editors.number={create:function(t,r){var i=e("<input type='text'/>");t.append(i);var l={minValue:r.editor.minValue,maxValue:r.editor.maxValue};return i.ligerSpinner(e.extend(l,r.editor.options||{})),i},setValue:function(e,t){e.val(t)},getValue:function(e,t){return"int"==t.editor.type?parseInt(e.val(),10):parseFloat(e.val())},destroy:function(e){e.liger("destroy")}},e.ligerDefaults.Filter.editors.combobox={create:function(t,r){var i=e("<input type='text'/>");t.append(i);var l={data:r.data,slide:!1,valueField:r.editor.valueField||r.editor.valueColumnName,textField:r.editor.textField||r.editor.displayColumnName};return e.extend(l,r.editor.options||{}),i.ligerComboBox(l),i},setValue:function(e,t){e.liger("option","value",t)},getValue:function(e){return e.liger("option","value")},destroy:function(e){e.liger("destroy")}},e.ligerui.controls.Filter=function(t,r){e.ligerui.controls.Filter.base.constructor.call(this,t,r)},e.ligerui.controls.Filter.ligerExtend(e.ligerui.core.UIComponent,{__getType:function(){return"Filter"},__idPrev:function(){return"Filter"},_init:function(){var t=this,r=this.options;e.ligerui.controls.Filter.base._init.call(this);for(var i in liger.editors){var l=liger.editors[i];!l||i in r.editors||(r.editors[i]=liger.getEditor(e.extend({type:i,master:t},l)))}},_render:function(){var t=this,r=this.options;t.set(r),e(t.element).bind("click",function(r){r.preventDefault();var i=e(r.target||r.srcElement),l=i.get(0).className;if(l.indexOf("addgroup")>=0){var s=i.parent().parent().parent().parent();t.addGroup(s)}else if(l.indexOf("deletegroup")>=0){var s=i.parent().parent().parent().parent();t.deleteGroup(s)}else if(l.indexOf("addrule")>=0){var s=i.parent().parent().parent().parent();t.addRule(s)}else if(l.indexOf("deleterole")>=0){var o=i.parent().parent();t.deleteRule(o)}})},_setFields:function(t){var r=this,i=this.options;r.group&&r.group.remove(),r.group=e(r._bulidGroupTableHtml()).appendTo(r.element),i.buttonCls&&r.group.find(".addgroup,.addrule,.deletegroup").addClass(i.buttonCls)},editors:{},editorCounter:0,addGroup:function(t){var r=this,i=this.options;t=e(t||r.group);var l=e(">tbody:first > tr:last",t),s=[];s.push('<tr class="l-filter-rowgroup"><td class="l-filter-cellgroup" colSpan="4">');var o=!t.hasClass("l-filter-group-alt");s.push(r._bulidGroupTableHtml(o,!0)),s.push("</td></tr>");var n=e(s.join(""));i.buttonCls&&n.find(".addgroup,.addrule,.deletegroup").addClass(i.buttonCls),l.before(n);var a=n.find("table:first");return i.addDefult&&r.addRule(a),a},deleteGroup:function(t){var r=this;this.options;e("td.l-filter-value",t).each(function(){var t=e(this).parent();e("select.fieldsel",t).unbind(),r.removeEditor(t)}),e(t).parent().parent().remove()},removeEditor:function(t){var r=this,i=this.options,l=e(t).attr("editortype"),s=e(t).attr("editorid"),o=r.editors[s];o&&i.editors[l].destroy&&i.editors[l].destroy(o),e("td.l-filter-value:first",t).html("")},setData:function(t,r){var i=this,l=this.options;r=r||i.group;var s=e(">tbody:first > tr:last",r);r&&r.find(">tbody:first > tr").not(s).remove(),e("select:first",s).val(t.op),t.rules&&e(t.rules).each(function(){var t=i.addRule(r),s=this.field,o=function(){for(var e=0;e<l.fields.length;e++)if(l.fields[e].name==s)return l.fields[e];return null}();e("select.opsel",t).html(i._bulidOpSelectOptionsHtml(this.type||"string",o.operator)),t.attr("fieldtype",this.type||"string"),e("select.opsel",t).val(this.op),e("select.fieldsel",t).val(this.field).trigger("change");var n=t.attr("editorid");if(n&&i.editors[n]){var o=i.getField(this.field);if(o&&o.editor){var a={field:o,filter:i};l.editors[o.editor.type].setValue.call(i,i.editors[n],this.value,a)}}else e(":text",t).val(this.value)}),t.groups&&e(t.groups).each(function(){var e=i.addGroup(r);i.setData(this,e)})},addRule:function(t){var r=this,i=this.options;t=t||r.group;var l=e(">tbody:first > tr:last",t),s=e(r._bulidRuleRowHtml());return l.before(s),i.fields.length&&r.appendEditor(s,i.fields[0]),e("select.fieldsel",s).bind("change",function(){var t=e(this).parent().next().find("select:first"),i=e(this).val();if(i){var l=r.getField(i),o=l.type||"string";o!=s.attr("fieldtype")&&(t.html(r._bulidOpSelectOptionsHtml(o,l.operator)),s.attr("fieldtype",o));var n=null,a=s.attr("editortype");r.enabledEditor(l)&&(n=l.editor.type),a&&r.removeEditor(s),n?r.appendEditor(s,l):(s.removeAttr("editortype").removeAttr("editorid"),e("td.l-filter-value:first",s).html('<input type="text" class="valtxt l-text" />'))}}),s},deleteRule:function(t){e("select.fieldsel",t).unbind(),this.removeEditor(t),e(t).remove()},appendEditor:function(t,r){var i=this,l=this.options;if(i.enabledEditor(r)){var s=e("td.l-filter-value:first",t).html(""),o=l.editors[r.editor.type],n=++i.editorCounter,a={filter:i};a.field=e.extend(!0,{},r),a.field.name=r.name+"_"+n,i.editors[n]=o.create.call(this,s,a),t.attr("editortype",r.editor.type).attr("editorid",n)}},getData:function(t){var r=this;this.options;t=t||r.group;var i={};return e("> tbody > tr",t).each(function(t,l){var s=e(l).hasClass("l-filter-rowlast");if(e(l).hasClass("l-filter-rowgroup")){var o=e("> td:first > table:first",l);o.length&&(i.groups||(i.groups=[]),i.groups.push(r.getData(o)))}else if(s)i.op=e(".groupopsel:first",l).val();else{var n=e("select.fieldsel:first",l).val(),a=r.getField(n),u=e(".opsel:first",l).val(),p=r._getRuleValue(l,a),d=e(l).attr("fieldtype")||"string";i.rules||(i.rules=[]),null!=p&&i.rules.push({field:n,op:u,value:p,type:d})}}),i},_getRuleValue:function(t,r){var i=this,l=this.options,s=e(t).attr("editorid"),o=e(t).attr("editortype"),n=i.editors[s],a={field:r,filter:i};return n?l.editors[o].getValue.call(i,n,a):e(".valtxt:first",t).val()},enabledEditor:function(e){var t=this.options;return!(!e.editor||!e.editor.type)&&e.editor.type in t.editors},getField:function(e){for(var t=this.options,r=0,i=t.fields.length;r<i;r++){var l=t.fields[r];if(l.name==e)return l}return null},_bulidGroupTableHtml:function(e,t){var r=this.options,i=[];return i.push('<table cellpadding="0" cellspacing="0" border="0" class="l-filter-group'),e&&i.push(" l-filter-group-alt"),i.push('"><tbody>'),i.push('<tr class="l-filter-rowlast"><td class="l-filter-rowlastcell" align="right" colSpan="4">'),i.push('<select class="groupopsel">'),i.push('<option value="and">'+r.strings.and+"</option>"),i.push('<option value="or">'+r.strings.or+"</option>"),i.push("</select>"),i.push('<input type="button" value="'+r.strings.addgroup+'" class="addgroup">'),i.push('<input type="button" value="'+r.strings.addrule+'" class="addrule">'),t&&i.push('<input type="button" value="'+r.strings.deletegroup+'" class="deletegroup">'),i.push("</td></tr>"),i.push("</tbody></table>"),i.join("")},_bulidRuleRowHtml:function(e){var t=this,r=this.options;e=e||r.fields;var i=[],l=e&&e.length&&e[0].type?e[0].type:"string";i.push('<tr fieldtype="'+l+'"><td class="l-filter-column">'),i.push('<select class="fieldsel">');for(var s=0,o=e.length;s<o;s++){var n=e[s];i.push('<option value="'+n.name+'"'),0==s&&i.push(" selected "),i.push(">"),i.push(n.display),i.push("</option>")}return i.push("</select>"),i.push("</td>"),i.push('<td class="l-filter-op">'),i.push('<select class="opsel">'),i.push(t._bulidOpSelectOptionsHtml(l,e&&e.length?e[0].operator:null)),i.push("</select>"),i.push("</td>"),i.push('<td class="l-filter-value">'),i.push('<input type="text" class="valtxt" />'),i.push("</td>"),i.push("<td>"),i.push('<div class="l-icon-cross deleterole"></div>'),i.push("</td>"),i.push("</tr>"),i.join("")},_bulidOpSelectOptionsHtml:function(e,t){var r=this.options,i=r.operators[e],l=[];t&&t.length&&(i=t.split(",")),i&&i.length||(i=["equal","notequal"]);for(var s=0,o=i.length;s<o;s++){var n=i[s];l[l.length]='<option value="'+n+'">',l[l.length]=r.strings[n],l[l.length]="</option>"}return l.join("")}}),e.ligerFilter=function(){},e.ligerFilter.filterTranslator={translateGroup:function(e){var t=[];if(null==e)return" 1==1 ";var r=!1;if(t.push("("),null!=e.rules)for(var i in e.rules)if("indexOf"!=i){var l=e.rules[i];r&&t.push(this.getOperatorQueryText(e.op)),t.push(this.translateRule(l)),r=!0}if(null!=e.groups)for(var s in e.groups){var o=e.groups[s];r&&t.push(this.getOperatorQueryText(e.op)),t.push(this.translateGroup(o)),r=!0}return t.push(")"),0==r?" 1==1 ":t.join("")},translateRule:function(e){var t=[];return null==e?" 1==1 ":"like"==e.op||"startwith"==e.op||"endwith"==e.op?(t.push("/"),"startwith"==e.op&&t.push("^"),t.push(e.value),"endwith"==e.op&&t.push("$"),t.push("/i.test("),t.push('o["'),t.push(e.field),t.push('"]'),t.push(")"),t.join("")):(t.push('o["'),t.push(e.field),t.push('"]'),t.push(this.getOperatorQueryText(e.op)),t.push('"'),t.push(e.value),t.push('"'),t.join(""))},getOperatorQueryText:function(e){switch(e){case"equal":return" == ";case"notequal":return" != ";case"greater":return" > ";case"greaterorequal":return" >= ";case"less":return" < ";case"lessorequal":return" <= ";case"and":return" && ";case"or":return" || ";default:return" == "}}},e.ligerFilter.getFilterFunction=function(t){e.isArray(t)&&(t={op:"and",rules:t});var r=" return  "+e.ligerFilter.filterTranslator.translateGroup(t);return new Function("o",r)}}(jQuery);