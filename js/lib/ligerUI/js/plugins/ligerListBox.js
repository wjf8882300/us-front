!function(e){e.fn.ligerListBox=function(t){return e.ligerui.run.call(this,"ligerListBox",arguments)},e.ligerDefaults.ListBox={isMultiSelect:!1,isShowCheckBox:!1,columns:null,width:150,height:100,onSelect:!1,onSelected:null,valueField:"id",textField:"text",valueFieldID:null,split:";",data:null,parms:null,url:null,urlParms:null,ajaxContentType:null,ajaxType:"post",onSuccess:null,onError:null,render:null,css:null,value:null,valueFieldCssClass:null},e.ligerMethos.ListBox=e.ligerMethos.ListBox||{},e.ligerui.controls.ListBox=function(t,l){e.ligerui.controls.ListBox.base.constructor.call(this,t,l)},e.ligerui.controls.ListBox.ligerExtend(e.ligerui.controls.Input,{__getType:function(){return"ListBox"},_extendMethods:function(){return e.ligerMethos.ListBox},_init:function(){e.ligerui.controls.ListBox.base._init.call(this)},_render:function(){var t=this,l=this.options;t.data=l.data,t.valueField=null,e(this.element).is(":hidden")||e(this.element).is(":text")?(t.valueField=e(this.element),e(this.element).is(":text")&&t.valueField.hide()):l.valueFieldID?(t.valueField=e("#"+l.valueFieldID+":input,[name="+l.valueFieldID+"]:input"),0==t.valueField.length&&(t.valueField=e('<input type="hidden"/>')),t.valueField[0].id=t.valueField[0].name=l.valueFieldID):(t.valueField=e('<input type="hidden"/>'),t.valueField[0].id=t.valueField[0].name=t.id+"_val"),null==t.valueField[0].name&&(t.valueField[0].name=t.valueField[0].id),l.valueFieldCssClass&&t.valueField.addClass(l.valueFieldCssClass),t.valueField.attr("data-ligerid",t.id),e(this.element).is(":hidden")||e(this.element).is(":text")?t.selectBox=e("<div></div>").insertBefore(this.element):t.selectBox=e(this.element),t.selectBox.html('<div class="l-listbox-inner"><table cellpadding="0" cellspacing="0" border="0" class="l-listbox-table"></table></div>').addClass("l-listbox").append(t.valueField),t.selectBox.table=e("table:first",t.selectBox),t.set(l),t._addClickEven()},destroy:function(){this.selectBox&&this.selectBox.remove(),this.options=null,e.ligerui.remove(this)},clear:function(){this._changeValue(""),this.trigger("clear")},_setIsShowCheckBox:function(t){t?e("table",this.selectBox).addClass("l-table-checkbox"):e("table",this.selectBox).addClass("l-table-nocheckbox")},_setCss:function(e){e&&this.selectBox.addClass(e)},_setDisabled:function(e){e?this.selectBox.addClass("l-text-disabled"):this.selectBox.removeClass("l-text-disabled")},_setWidth:function(e){this.selectBox.width(e)},_setHeight:function(e){this.selectBox.height(e)},getText:function(){var e=this.getValue();return this.findTextByValue(e)},findTextByValue:function(t){var l=this,i=this.options;if(null==t||""==t)return"";var s=[],a=function(e){for(var l=t.toString().split(i.split),s=0;s<l.length;s++)if(l[s]==e)return!0;return!1};return e(l.data).each(function(e,t){var l=t[i.valueField],n=t[i.textField];a(l)&&s.push(n)}),s.join(i.split)},getDataByValue:function(e){for(var t=this,l=this.options,i=0,s=t.data.length;i<s;i++)if(t.data[i][l.valueField]==e)return t.data[i];return null},indexOf:function(e){var t=this,l=this.options;if(!t.data)return-1;for(var i="object"==typeof e,s=0,a=t.data.length;s<a;s++)if(i){if(t.data[s]==e)return s}else if(t.data[s][l.valueField]&&t.data[s][l.valueField].toString()==e.toString())return s;return-1},removeItems:function(t){var l=this;l.data&&(e(t).each(function(e,t){var i=l.indexOf(t);-1!=i&&l.data.splice(i,1)}),l.refresh())},removeItem:function(e){if(this.data){var t=this.indexOf(e);-1!=t&&(this.data.splice(t,1),this.refresh())}},insertItem:function(e,t){var l=this;l.data||(l.data=[]),l.data.splice(t,0,e),l.refresh()},addItems:function(t){var l=this;l.data||(l.data=[]),e(t).each(function(e,t){l.data.push(t)}),l.refresh()},addItem:function(e){var t=this;t.data||(t.data=[]),t.data.push(e),t.refresh()},getSelectedItems:function(){var t=this,l=this.options;if(!t.data)return null;var i=t.getValue();if(!i)return null;var s=[];return e(i.split(l.split)).each(function(){var e=t.indexOf(this.toString());-1!=e&&s.push(t.data[e])}),s},_setValue:function(e){this.options.value=e,this._dataInit()},setValue:function(e){this._setValue(e)},_setUrl:function(t){if(t){var l=this,i=this.options,s=e.isFunction(i.urlParms)?i.urlParms.call(l):i.urlParms;if(s)for(name in s)t+=-1==t.indexOf("?")?"?":"&",t+=name+"="+s[name];var a=e.isFunction(i.parms)?i.parms():i.parms;"application/json"==i.ajaxContentType&&"string"!=typeof a&&(a=liger.toJSON(a));var n={type:i.ajaxType||"post",url:t,data:a,cache:!1,dataType:"json",success:function(e){l.setData(e),l.trigger("success",[e])},error:function(e,t){l.trigger("error",[e,t])}};i.ajaxContentType&&(n.contentType=i.ajaxContentType),e.ajax(n)}},reload:function(){this.set("url",this.options.url)},setUrl:function(e){return this._setUrl(e)},setParm:function(e,t){if(e){var l=this,i=l.get("parms");i||(i={}),i[e]=t,l.set("parms",i)}},clearContent:function(){var t=this;this.options;e("table",t.selectBox).html("")},_setColumns:function(e){var t=this;this.options.columns=e,t.refresh()},_setData:function(e){this.setData(e)},setData:function(e){var t=this;this.options;e&&e.length&&(t.data=e,t.refresh(),t.updateStyle())},refresh:function(){var t=this,l=this.options,i=this.data;if(this.clearContent(),i){if(l.columns){t.selectBox.table.headrow=e("<tr class='l-table-headerow'><td width='18px' class='l-checkboxrow'></td></tr>"),t.selectBox.table.append(t.selectBox.table.headrow),t.selectBox.table.addClass("l-listbox-grid");for(var s=0;s<l.columns.length;s++){var a=e("<td columnindex='"+s+"' columnname='"+l.columns[s].name+"'>"+l.columns[s].header+"</td>");l.columns[s].width&&a.width(l.columns[s].width),t.selectBox.table.headrow.append(a)}}for(var n=[],o=0;o<i.length;o++){var r=i[o][l.valueField],u=i[o][l.textField],c=" value='"+r+"' index='"+o+"'";if(l.columns){n.push("<tr "+c+"><td style='width:18px;' class='l-checkboxrow'><input type='checkbox' "+c+"/></td>");for(var s=0;s<l.columns.length;s++){var d=l.columns[s].name;n.push("<td>"+i[o][d]+"</td>")}n.push("</tr>")}else{n.push("<tr "+c+">"),n.push("<td style='width:18px;' class='l-checkboxrow'><input type='checkbox'"+c+"/></td>");var h=u;l.render&&(h=l.render({data:i[o],value:r,text:u})),n.push("<td align='left'>"+h+"</td></tr>")}}t.selectBox.table.append(n.join(""))}},_getValue:function(){return e(this.valueField).val()},getValue:function(){return this._getValue()},updateStyle:function(){this._dataInit()},selectAll:function(){var t=this,l=this.options,i=[];e("tr",t.selectBox).each(function(){var t=e(this);i.push(t.attr("value"))}),e("tr",t.selectBox).addClass("l-selected").find(":checkbox").each(function(){this.checked=!0}),t.valueField.val(i.join(l.split))},_dataInit:function(){var t=this,l=this.options,i=l.value;null!=i?t._changeValue(i):""!=t.valueField.val()&&(l.value=t.valueField.val());var s=(i||"").toString().split(l.split);e("tr.l-selected",t.selectBox).removeClass("l-selected").find(":checkbox").each(function(){this.checked=!1}),e(s).each(function(l,i){e("tr[value='"+i+"']",t.selectBox).addClass("l-selected").find(":checkbox").each(function(){this.checked=!0})})},_changeValue:function(e){var t=this;this.options;t.valueField.val(e),t.selectedValue=e},_updateValue:function(){var t=this,l=this.options,i=[];e("tr",t.selectBox).each(function(){var t=e(this);t.hasClass("l-selected")&&i.push(t.attr("value"))}),t._changeValue(i.join(l.split))},_addClickEven:function(){var t=this,l=this.options;t.selectBox.click(function(i){var s=i.target||i.srcElement,a=e(s).parents("tr:first");if(a.length){var n=a.attr("value"),o=t.findTextByValue(n),r=t.getDataByValue(n);if(t.hasBind("select")&&0==t.trigger("select",[n,o,r]))return!1;l.isMultiSelect||e("tr.l-selected",t.selectBox).not(a).removeClass("l-selected").find(":checkbox").each(function(){this.checked=!1}),a.hasClass("l-selected")?a.removeClass("l-selected"):a.addClass("l-selected"),a.find(":checkbox").each(function(){this.checked=a.hasClass("l-selected")}),t._updateValue(),t.trigger("selected",[n,o,r])}})}})}(jQuery);