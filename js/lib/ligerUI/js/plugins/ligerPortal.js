!function(n){n.fn.ligerPortal=function(e){return n.ligerui.run.call(this,"ligerPortal",arguments)},n.ligerDefaults.Portal={width:null,rows:null,columns:null,url:null,method:"get",parms:null,draggable:!1,onLoaded:null},n.ligerDefaults.Portal_rows={width:null,height:null},n.ligerDefaults.Portal_columns={width:null,height:null},n.ligerMethos.Portal={},n.ligerui.controls.Portal=function(e,t){n.ligerui.controls.Portal.base.constructor.call(this,e,t)},n.ligerui.controls.Portal.ligerExtend(n.ligerui.core.UIComponent,{__getType:function(){return"Portal"},__idPrev:function(){return"Portal"},_extendMethods:function(){return n.ligerMethos.Portal},_init:function(){var e=this,t=this.options;n.ligerui.controls.Portal.base._init.call(this),n(">div",e.element).length&&(t.columns=[],n(">div",e.element).each(function(n,e){t.columns[n]={panels:[]}}),e.tempInitPanels=n("<div></div>"),n(">div",e.element).appendTo(e.tempInitPanels)),!t.rows&&t.columns&&(t.rows=[{columns:t.columns}])},_render:function(){var e=this,t=this.options;e.portal=n(e.element).addClass("l-portal").html(""),e.set(t)},_setRows:function(e){var t=this;this.options;if(t.rows=[],e&&e.length)for(var l=0;l<e.length;l++){var i=e[l],s=n('<div class="l-row"></div>').appendTo(t.portal);t.rows[l]=t._renderRow({row:i,rowIndex:l,jrow:s}),s.append('<div class="l-clear"></div>')}},_renderRow:function(e){var t=e.row,l=e.rowIndex,i=e.jrow,s=this,o=(this.options,{element:i[0]});if(t.width&&("string"==typeof t.width?t.width.indexOf("%")>-1?i.width(t.width):i.width(parseInt(t.width)):i.width(t.width)),t.height&&i.height(t.height),t.columns&&(o.columns=[]),t.columns&&t.columns.length)for(var a=0;a<t.columns.length;a++){var r=t.columns[a],c=n('<div class="l-column"></div>').appendTo(i);o.columns[a]=s._renderColumn({column:r,columnIndex:a,jcolumn:c,rowIndex:l})}return o},remove:function(n){var e=this,t=(this.options,n.rowIndex),l=n.columnIndex,i=n.index;if(null==i&&(i=-1),i>=0&&e.rows[t]&&e.rows[t].columns&&e.rows[t].columns[l]&&e.rows[t].columns[l].panels){var s=e.rows[t].columns[l].panels[i];s&&s.close(),e._updatePortal()}},add:function(e){var t=this,l=this.options,i=e.rowIndex,s=e.columnIndex,o=e.index,a=e.panel;if(null==o&&(o=-1),t.rows[i]&&t.rows[i].columns&&t.rows[i].columns[s]){var r,c=t.rows[i].columns[s],p=l.rows[i].columns[s];n(c.element);if(p.panels=p.panels||[],c.panels=c.panels||[],p.panels.splice(o,0,a),o<0){var u=n("<div></div>").insertBefore(c.jplace);r=u.ligerPanel(a)}else if(c.panels[o]){var u=n("<div></div>").insertBefore(c.panels[o].panel);r=u.ligerPanel(a)}r&&(r.bind("closed",t._createPanelClosed()),t.setPanelEvent({panel:r}),c.panels.splice(o,0,r)),t._updatePortal()}},_createPanelClosed:function(){var e=this,t=this.options;return function(){var l,i,s,o=this,a=e.getPanels();n(a).each(function(){this.panel==o&&(l=this.rowIndex,i=this.columnIndex,s=this.index)}),t.rows[l].columns[i].panels.splice(s,1),e.rows[l].columns[i].panels.splice(s,1)}},_renderColumn:function(e){var t=e.column,l=e.columnIndex,i=e.jcolumn,s=(e.rowIndex,this),o=(this.options,{element:i[0]});if(t.width&&i.width(t.width),t.height&&i.height(t.height),t.panels&&(o.panels=[]),t.panels&&t.panels.length)for(var a=0;a<t.panels.length;a++){var r=t.panels[a],c=n("<div></div>").appendTo(i);o.panels[a]=c.ligerPanel(r),o.panels[a].bind("closed",s._createPanelClosed()),s.setPanelEvent({panel:o.panels[a]})}else if(s.tempInitPanels){var p=s.tempInitPanels.find(">div:eq("+l+")");if(p.length){o.panels=[];var u={},h=p.clone();liger.inject&&liger.inject.getOptions&&(u=liger.inject.getOptions({jelement:h,defaults:n.ligerDefaults.Panel,config:liger.inject.config.Panel})),o.panels[0]=h.appendTo(i).ligerPanel(u),o.panels[0].bind("closed",s._createPanelClosed()),s.setPanelEvent({panel:o.panels[0]})}}return o.jplace=n('<div class="l-column-place"></div>').appendTo(i),o},setPanelEvent:function(e){var t=e.panel,s=t.panel,o=this,a=this.options;n.fn.ligerDrag&&a.draggable&&s.addClass("l-panel-draggable").ligerDrag({proxy:!1,revert:!0,handler:".l-panel-header span:first",onRendered:function(){},onStartDrag:function(e,t){o.portal.find(">.l-row").addClass("l-row-dragging"),this.jplace=n('<div class="l-panel-place"></div>'),this.jplace.height(s.height()),s.width(s.width()),s.addClass("l-panel-dragging"),s.css("position","absolute"),s.after(this.jplace),o._updatePortal()},onDrag:function(n,e){function a(n,e,t,l){var i=n?n.jpanel:e.jplace;if(!i)return null;var s=i.height(),o=i.width(),a=i.offset().left,r=i.offset().top;if(t>a-3&&t<a+o+3){if(l>r-3&&l<r+s/2+3)return{panel:n,column:e,position:"top"};if(l>r+s/2-3&&l<r+s+3)return{panel:n,column:e,position:n?"bottom":"top"}}return null}var r=(e.pageX||e.screenX,e.pageY||e.screenY,s.height(),s.width()),c=s.offset(),p=c.left+r/2,u=c.top+10,h=o.getPanels(),d=o.getEmptyColumns(),m=function(n,e,s,o){for(i=0,l=n.length;i<l;i++){var r=n[i];if(r.panel!=t){var c=a(r,null,s,o);if(c)return c}}for(i=0,l=e.length;i<l;i++){var p=e[i],c=a(null,p,s,o);if(c)return c}return null}(h,d,p,u);if(m){if(this.placeStatus){if(this.placeStatus.panel&&m.panel&&this.placeStatus.panel.rowIndex==m.panel.rowIndex&&this.placeStatus.panel.columnIndex==m.panel.columnIndex&&this.placeStatus.panel.index==m.panel.index&&this.placeStatus.position==m.position)return;if(this.placeStatus.column&&m.column&&this.placeStatus.column.rowIndex==m.column.rowIndex&&this.placeStatus.column.columnIndex==m.column.columnIndex&&this.placeStatus.position==m.position)return}"top"==m.position?(this.jplace.insertBefore(m.panel?m.panel.jpanel:m.column.jplace),this.savedPosition=m.panel?m.panel:m.column,this.savedPosition.inTop=!0):"bottom"==m.position&&(this.jplace.insertAfter(m.panel.jpanel),this.savedPosition=m.panel,this.savedPosition.inTop=!1),this.placeStatus=m}else this.placeStatus=null},onStopDrag:function(e,l){if(o.portal.find(">.l-row").removeClass("l-row-dragging"),t.set("width",t.get("width")),s.removeClass("l-panel-dragging"),this.jplace&&(s.css({position:"relative",left:null,top:null}),s.insertAfter(this.jplace),o.portal.find(">.l-row > .l-column >.l-panel-place").remove(),this.savedPosition)){var i,r,c,p=o.getPanels();n(p).each(function(){this.panel==t&&(i=this.rowIndex,r=this.columnIndex,c=this.index)});var u=a.rows[i].columns[r].panels[c],h=o.rows[i].columns[r].panels[c];a.rows[i].columns[r].panels.splice(c,1),o.rows[i].columns[r].panels.splice(c,1),this.savedPosition.panel?(a.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels.splice(this.savedPosition.index+this.savedPosition.inTop?-1:0,0,u),o.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels.splice(this.savedPosition.index+this.savedPosition.inTop?-1:0,0,h)):(a.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels=[u],o.rows[this.savedPosition.rowIndex].columns[this.savedPosition.columnIndex].panels=[h])}return o._updatePortal(),!1}})},_updatePortal:function(){var e=this;this.options;n(e.rows).each(function(e){n(this.columns).each(function(e){this.panels&&this.panels.length?n(this.element).removeClass("l-column-empty"):n(this.element).addClass("l-column-empty")})})},getPanels:function(){var e=this,t=(this.options,[]);return n(e.rows).each(function(e){n(this.columns).each(function(l){n(this.panels).each(function(n){t.push({rowIndex:e,columnIndex:l,index:n,panel:this,jpanel:this.panel})})})}),t},getPanel:function(e){var t=this;this.options;e=n.extend({rowIndex:0,columnIndex:0,index:0},e);var l=null;return n(t.rows).each(function(t){n(this.columns).each(function(i){n(this.panels).each(function(n){l||t==e.rowIndex&&i==e.columnIndex&&n==e.index&&(l=this)})})}),l},getEmptyColumns:function(){var e=this,t=(this.options,[]);return n(e.rows).each(function(e){n(this.columns).each(function(n){this.panels&&this.panels.length||t.push({rowIndex:e,columnIndex:n,jplace:this.jplace})})}),t},_setUrl:function(e){var t=this,l=this.options;e&&n.ajax({url:e,data:l.parms,type:l.method,dataType:"json",success:function(n){t.set("rows",n)}})},_setWidth:function(n){n&&this.portal.width(n)},collapseAll:function(){var e=this,t=(this.options,e.getPanels());n(t).each(function(n,e){e.panel.collapse()})},expandAll:function(){var e=this,t=(this.options,e.getPanels());n(t).each(function(n,e){e.panel.expand()})}})}(jQuery);