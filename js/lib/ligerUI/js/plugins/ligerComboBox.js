!function(e){e.fn.ligerComboBox=function(t){return e.ligerui.run.call(this,"ligerComboBox",arguments)},e.fn.ligerGetComboBoxManager=function(){return e.ligerui.run.call(this,"ligerGetComboBoxManager",arguments)},e.ligerDefaults.ComboBox={resize:!0,isMultiSelect:!1,isShowCheckBox:!1,columns:null,width:null,selectBoxWidth:null,selectBoxHeight:120,selectBoxPosYDiff:-3,onBeforeSelect:!1,onAfterShowData:null,onSelected:null,initValue:null,value:null,initText:null,valueField:"id",textField:"text",dataParmName:null,valueFieldID:null,ajaxComplete:null,ajaxBeforeSend:null,ajaxContentType:null,slide:!1,split:";",data:null,dataGetter:null,tree:null,treeLeafOnly:!0,condition:null,grid:null,onStartResize:null,onEndResize:null,hideOnLoseFocus:!0,hideGridOnLoseFocus:!1,url:null,urlParms:null,selectBoxRender:null,selectBoxRenderUpdate:null,detailEnabled:!0,detailUrl:null,detailPostIdField:null,detailDataParmName:null,detailParms:null,detailDataGetter:null,delayLoad:!1,triggerToLoad:!1,emptyText:null,addRowButton:"新增",addRowButtonClick:null,triggerIcon:null,onSuccess:null,onBeforeSetData:null,onError:null,onBeforeOpen:null,onButtonClick:null,onTextBoxKeyDown:null,onTextBoxKeyEnter:null,render:null,absolute:!0,cancelable:!0,css:null,parms:null,renderItem:null,autocomplete:!1,autocompleteAllowEmpty:!0,isTextBoxMode:!1,highLight:!1,readonly:!1,ajaxType:"post",alwayShowInTop:!1,alwayShowInDown:!1,valueFieldCssClass:null,isRowReadOnly:null,rowClsRender:null,keySupport:!1,initIsTriggerEvent:!1,conditionSearchClick:null,onChangeValue:null,delayLoadGrid:!0,setTextBySource:!0},e.ligerDefaults.ComboBoxString={Search:"搜索"},e.ligerMethos.ComboBox=e.ligerMethos.ComboBox||{},e.ligerui.controls.ComboBox=function(t,l){e.ligerui.controls.ComboBox.base.constructor.call(this,t,l)},e.ligerui.controls.ComboBox.ligerExtend(e.ligerui.controls.Input,{__getType:function(){return"ComboBox"},_extendMethods:function(){return e.ligerMethos.ComboBox},_init:function(){e.ligerui.controls.ComboBox.base._init.call(this);var t=this.options;t.columns&&(t.isShowCheckBox=!0),t.isMultiSelect&&(t.isShowCheckBox=!0),t.triggerToLoad&&(t.delayLoad=!0)},_render:function(){var t=this,l=this.options;t.data=l.data,t.inputText=null,t.select=null,t.textFieldID="",t.valueFieldID="",t.valueField=null,e(this.element).is(":hidden")?(t.valueField=e(this.element),t.textFieldID=l.textFieldID||this.element.id+"_txt",t.inputText=e('<input type="text" readonly="true"/>'),t.inputText.attr("id",t.textFieldID).insertAfter(e(this.element)),t.valueField.attr("validate")&&(t.inputText.attr("validate",t.valueField.attr("validate")),t.valueField.removeAttr("validate")),t.valueField.attr("validateMessage")&&(t.inputText.attr("validateMessage",t.valueField.attr("validateMessage")),t.valueField.removeAttr("validateMessage"))):"input"==this.element.tagName.toLowerCase()?(this.element.readOnly=!0,t.inputText=e(this.element),t.textFieldID=this.element.id):"select"==this.element.tagName.toLowerCase()&&(e(this.element).hide(),t.select=e(this.element),l.isMultiSelect=!1,l.isShowCheckBox=!1,l.cancelable=!1,t.textFieldID=l.textFieldID||this.element.id+"_txt",t.inputText=e('<input type="text" readonly="true"/>'),t.inputText.attr("id",t.textFieldID).insertAfter(e(this.element)),t.select.attr("validate")&&(t.inputText.attr("validate",t.select.attr("validate")),t.select.removeAttr("validate")),t.select.attr("validateMessage")&&(t.inputText.attr("validateMessage",t.select.attr("validateMessage")),t.select.removeAttr("validateMessage")),!l.value&&this.element.value&&(l.value=this.element.value)),void 0==t.inputText[0].name&&(t.inputText[0].name=t.textFieldID),t.inputText.attr("data-comboboxid",t.id),null==t.valueField&&(l.valueFieldID?(t.valueField=e("#"+l.valueFieldID+":input,[name="+l.valueFieldID+"]:input").filter("input:hidden"),0==t.valueField.length&&(t.valueField=e('<input type="hidden"/>')),t.valueField[0].id=t.valueField[0].name=l.valueFieldID):(t.valueField=e('<input type="hidden"/>'),t.valueField[0].id=t.valueField[0].name=t.textFieldID+"_val")),l.valueFieldCssClass&&t.valueField.addClass(l.valueFieldCssClass),void 0==t.valueField[0].name&&(t.valueField[0].name=t.valueField[0].id),null!=l.initValue&&(t.valueField[0].value=l.initValue),t.valueField.attr("data-ligerid",t.id),t.link=e('<div class="l-trigger"><div class="l-trigger-icon"></div></div>'),l.triggerIcon&&t.link.find("div:first").addClass(l.triggerIcon),t.selectBox=e('<div class="l-box-select" style="display:none"><div class="l-box-select-inner"><table cellpadding="0" cellspacing="0" border="0" class="l-box-select-table"></table></div></div>'),t.selectBox.table=e("table:first",t.selectBox),t.selectBoxInner=t.selectBox.find(".l-box-select-inner:first"),t.wrapper=t.inputText.wrap('<div class="l-text l-text-combobox"></div>').parent(),t.wrapper.append('<div class="l-text-l"></div><div class="l-text-r"></div>'),t.wrapper.append(t.link),t.textwrapper=t.wrapper.wrap('<div class="l-text-wrapper"></div>').parent(),l.absolute?t.selectBox.appendTo("body").addClass("l-box-select-absolute"):t.textwrapper.append(t.selectBox),t.textwrapper.append(t.valueField),t.inputText.addClass("l-text-field"),l.isShowCheckBox&&!t.select?e("table",t.selectBox).addClass("l-table-checkbox"):(l.isShowCheckBox=!1,e("table",t.selectBox).addClass("l-table-nocheckbox")),t.link.hover(function(){l.disabled||l.readonly||(this.className="l-trigger-hover")},function(){l.disabled||l.readonly||(this.className="l-trigger")}).mousedown(function(){l.disabled||l.readonly||(this.className="l-trigger-pressed")}).mouseup(function(){l.disabled||l.readonly||(this.className="l-trigger-hover")}).click(function(){if(!l.disabled&&!l.readonly)return 0!=t.trigger("buttonClick")&&(0!=t.trigger("beforeOpen")&&void(l.triggerToLoad&&!t.triggerLoaded?(t.triggerLoaded=!0,t._setUrl(l.url,function(){t._toggleSelectBox(t.selectBox.is(":visible"))})):t._toggleSelectBox(t.selectBox.is(":visible"))))}),t.inputText.click(function(){if(!l.disabled&&!l.readonly)return 0!=t.trigger("beforeOpen")&&void(l.autocomplete?t.updateSelectBoxPosition():l.triggerToLoad&&!t.triggerLoaded?(t.triggerLoaded=!0,t._setUrl(l.url,function(){t._toggleSelectBox(t.selectBox.is(":visible"))})):t._toggleSelectBox(t.selectBox.is(":visible")))}).blur(function(){l.disabled||t.wrapper.removeClass("l-text-focus")}).focus(function(){l.disabled||l.readonly||t.wrapper.addClass("l-text-focus")}).change(function(){t.trigger("changeValue",[this.value])}),t.wrapper.hover(function(){l.disabled||l.readonly||t.wrapper.addClass("l-text-over")},function(){l.disabled||l.readonly||t.wrapper.removeClass("l-text-over")}),t.resizing=!1,t.selectBox.hover(null,function(e){l.hideOnLoseFocus&&t.selectBox.is(":visible")&&!t.boxToggling&&!t.resizing&&t._toggleSelectBox(!0)}),t.bulidContent(),t.set(l,null,"init"),l.selectBoxWidth?t.selectBox.width(l.selectBoxWidth):t.selectBox.css("width",t.wrapper.css("width")),l.grid&&(l.delayLoadGrid?t.bind("show",function(){t.grid||(t.setGrid(l.grid),t.set("SelectBoxHeight",l.selectBoxHeight))}):t.grid||(t.setGrid(l.grid),t.set("SelectBoxHeight",l.selectBoxHeight))),t.updateSelectBoxPosition(),e(document).bind("click.combobox",function(l){t.selectBox.is(":visible")&&0==e(l.target||l.srcElement).closest(".l-box-select, .l-text-combobox").length&&t._toggleSelectBox(!0)})},destroy:function(){this.wrapper&&this.wrapper.remove(),this.selectBox&&this.selectBox.remove(),this.options=null,e.ligerui.remove(this)},clear:function(){this._changeValue("",""),e("a.l-checkbox-checked",this.selectBox).removeClass("l-checkbox-checked"),e("td.l-selected",this.selectBox).removeClass("l-selected"),e(":checkbox",this.selectBox).each(function(){this.checked=!1}),this.trigger("clear")},_setSelectBoxHeight:function(t){if(t){var l=this,i=this.options;if(i.grid)l.grid&&l.grid.set("height",l.getGridHeight(t));else if(i.tree)l.selectBoxInner.height(i.selectBoxHeight);else{var a=e("tr",l.selectBox.table).length;!i.selectBoxHeight&&a<8&&(i.selectBoxHeight=30*a),i.selectBoxHeight&&(a<8?l.selectBoxInner.height("auto"):l.selectBoxInner.height(i.selectBoxHeight))}}},_setCss:function(e){e&&this.wrapper.addClass(e)},_setCancelable:function(t){var l=this,i=this.options;!t&&l.unselect&&(l.unselect.remove(),l.unselect=null),(t||l.unselect)&&(l.unselect=e('<div class="l-trigger l-trigger-cancel"><div class="l-trigger-icon"></div></div>').hide(),l.wrapper.hover(function(){l.unselect.show()},function(){l.unselect.hide()}),i.disabled||i.readonly||!i.cancelable||l.wrapper.append(l.unselect),l.unselect.hover(function(){this.className="l-trigger-hover l-trigger-cancel"},function(){this.className="l-trigger l-trigger-cancel"}).click(function(){l.clear()}))},_setDisabled:function(e){e?this.wrapper.addClass("l-text-disabled"):this.wrapper.removeClass("l-text-disabled")},_setReadonly:function(e){e?this.wrapper.addClass("l-text-readonly"):this.wrapper.removeClass("l-text-readonly")},_setLable:function(t){var l=this,i=this.options;t&&(l.labelwrapper?l.labelwrapper.find(".l-text-label:first").html(t+":&nbsp"):(l.labelwrapper=l.textwrapper.wrap('<div class="l-labeltext"></div>').parent(),l.labelwrapper.prepend('<div class="l-text-label" style="float:left;display:inline;">'+t+":&nbsp</div>"),l.textwrapper.css("float","left")),i.labelWidth?e(".l-text-label",l.labelwrapper).outerWidth(i.labelWidth):i.labelWidth=e(".l-text-label",l.labelwrapper).outerWidth(),e(".l-text-label",l.labelwrapper).width(i.labelWidth),e(".l-text-label",l.labelwrapper).height(l.wrapper.height()),l.labelwrapper.append('<br style="clear:both;" />'),i.labelAlign&&e(".l-text-label",l.labelwrapper).css("text-align",i.labelAlign),l.textwrapper.css({display:"inline"}),l.labelwrapper.width(l.wrapper.outerWidth()+i.labelWidth+2))},_setWidth:function(e){var t=this,l=this.options;e>20&&(t.wrapper.css({width:e}),t.inputText.css({width:e-20}),l.selectBoxWidth||t.selectBox.css({width:e}))},_setHeight:function(e){var t=this;e>10&&(t.wrapper.height(e),t.inputText.height(e-2))},_setResize:function(t){var l=this,i=this.options;if(!i.columns&&t&&e.fn.ligerResizable){var a=i.selectBoxHeight?"e":"se,s,e";l.selectBox.ligerResizable({handles:a,onStartResize:function(){l.resizing=!0,l.trigger("startResize")},onEndResize:function(){if(l.resizing=!1,0==l.trigger("endResize"))return!1},onStopResize:function(e,t){return!l.grid||(e.newWidth&&l.selectBox.width(e.newWidth),e.newHeight&&l.set({selectBoxHeight:e.newHeight}),l.grid.refreshSize(),l.trigger("endResize"),!1)}}),l.selectBox.append("<div class='l-btn-nw-drop'></div>")}},findTextByValue:function(t){var l=this,i=this.options;if(null==t)return"";var a,o="",n=function(e){for(var l=t.toString().split(i.split),a=0;a<l.length;a++)if(l[a]==e&&""!=l[a])return!0;return!1};return a=l.options.grid&&l.options.grid.data?l.options.grid.data.Rows:l.data,e(a).each(function(e,t){var l=t[i.valueField],a=t[i.textField];n(l)&&(o+=a+i.split)}),o.length>0&&(o=o.substr(0,o.length-1)),o},findValueByText:function(t){var l=this,i=this.options;if(!t&&""==t)return"";var a=function(e){for(var l=t.toString().split(i.split),a=0;a<l.length;a++)if(l[a]==e)return!0;return!1},o="";return e(l.data).each(function(e,t){var l=t[i.valueField],n=t[i.textField];a(n)&&(o+=l+i.split)}),o.length>0&&(o=o.substr(0,o.length-1)),o},insertItem:function(e,t){var l=this;this.options;l.data=l.data||[],l.data.splice(t,0,e),l.setData(l.data)},addItem:function(e){var t=this;this.options;t.insertItem(e,(t.data||[]).length)},_setIsTextBoxMode:function(e){var t=this;this.options;e&&t.inputText.removeAttr("readonly")},_setValue:function(t,l){var i=this,a=this.options,o=!0;if("init"==l&&(l=null,!0,o=!!a.initIsTriggerEvent),l=a.isTextBoxMode?t:l||i.findTextByValue(t),a.tree)setTimeout(function(){a.setTextBySource?i.selectValueByTree(t):i.treeSelectInit(t)},100);else if(a.isMultiSelect){if(i._changeValue(t,l,o),null!=t){var n=t.toString().split(a.split);e("table.l-table-checkbox :checkbox",i.selectBox).each(function(){this.checked=!1});for(var s=0;s<n.length;s++)e("table.l-table-checkbox tr[value="+n[s]+"] :checkbox",i.selectBox).each(function(){this.checked=!0})}}else i._changeValue(t,l,o),e("tr[value='"+t+"'] td",i.selectBox).addClass("l-selected"),e("tr[value!='"+t+"'] td",i.selectBox).removeClass("l-selected");a.selectBoxRenderUpdate&&a.selectBoxRenderUpdate.call(i,{selectBox:i.selectBox,value:t,text:l})},selectValue:function(e){this._setValue(e)},bulidContent:function(){var e=this,t=this.options;this.clearContent(),e.select?e.setSelect():t.tree&&e.setTree(t.tree)},reload:function(){var e=this,t=this.options;t.url?e.set("url",t.url):e.grid&&e.grid.reload()},_setUrl:function(t,l){if(t){var i=this,a=this.options;if(!a.readonly){if(a.delayLoad&&!i.isAccessDelay&&!i.triggerLoaded)return void(i.isAccessDelay=!0);t=e.isFunction(t)?t.call(i):t;var o=e.isFunction(a.urlParms)?a.urlParms.call(i):a.urlParms;if(o)for(name in o)t+=-1==t.indexOf("?")?"?":"&",t+=name+"="+o[name];var n=e.isFunction(a.parms)?a.parms.call(i):a.parms;"application/json"==a.ajaxContentType&&"string"!=typeof n&&(n=liger.toJSON(n));var s={type:a.ajaxType,url:t,data:n,cache:!1,dataType:"json",beforeSend:a.ajaxBeforeSend,complete:a.ajaxComplete,success:function(t){var o=e.isFunction(a.dataGetter)?o=a.dataGetter.call(i,t):t;o=a.dataParmName&&o?o[a.dataParmName]:o,0!=i.trigger("beforeSetData",[o])&&(i.setData(o),i.trigger("success",[o]),e.isFunction(l)&&l(o))},error:function(e,t){i.trigger("error",[e,t])}};a.ajaxContentType&&(s.contentType=a.ajaxContentType),e.ajax(s)}}},setUrl:function(e,t){return this._setUrl(e,t)},setParm:function(e,t){if(e){var l=this,i=l.get("parms");i||(i={}),i[e]=t,l.set("parms",i)}},clearContent:function(){var t=this,l=this.options;t&&(e("table",t.selectBox).html(""),t&&t._setSelectBoxHeight(l.selectBoxHeight))},setSelect:function(){var t=this,l=this.options;this.clearContent(),t.data=[],e("option",t.select).each(function(l){var i=e(this).val(),a=e(this).html();t.data.push({text:a,id:i});var o=e("<tr><td index='"+l+"' value='"+i+"' text='"+a+"'>"+a+"</td>");e("table.l-table-nocheckbox",t.selectBox).append(o),e("td",o).hover(function(){e(this).addClass("l-over").siblings("td").removeClass("l-over")},function(){e(this).removeClass("l-over")})}),e("td:eq("+t.select[0].selectedIndex+")",t.selectBox).each(function(){if(e(this).hasClass("l-selected"))return void t.selectBox.hide();e(".l-selected",t.selectBox).removeClass("l-selected"),e(this).addClass("l-selected"),t.select[0].selectedIndex!=e(this).attr("index")&&t.select[0].onchange&&(t.select[0].selectedIndex=e(this).attr("index"),t.select[0].onchange());var i=parseInt(e(this).attr("index"));t.select[0].selectedIndex=i,t.select.trigger("change"),t.selectBox.hide();var a=e(this).attr("value"),o=e(this).html();l.render?t.inputText.val(l.render(a,o)):t.inputText.val(o)}),t._addClickEven()},_setData:function(e){this.setData(e)},getRowIndex:function(e){var t=this,l=this.options;if(!e)return-1;if(!t.data||!t.data.length)return-1;for(var i=0;i<t.data.length;i++)if(null!=t.data[i]){var a=t.data[i][l.valueField];if(a==e)return i}return-1},getRow:function(e){var t=this,l=this.options;if(!e)return null;if(!t.data||!t.data.length)return null;for(var i=0;i<t.data.length;i++)if(null!=t.data[i]){var a=t.data[i][l.valueField];if(a==e)return t.data[i]}return null},setData:function(t){var l=this,i=this.options;if(!l.select){if(i.selectBoxRender)return void i.selectBoxRender.call(l,{selectBox:l.selectBox,data:t});if(t&&t.length||(t=[]),l.data!=t&&(l.data=t),l.data=e.isFunction(l.data)?l.data():l.data,this.clearContent(),i.columns){l.selectBox.table.headrow=e("<tr class='l-table-headerow'><td width='18px'></td></tr>"),l.selectBox.table.append(l.selectBox.table.headrow),l.selectBox.table.addClass("l-box-select-grid");for(var a=0;a<i.columns.length;a++){var o=e("<td columnindex='"+a+"' columnname='"+i.columns[a].name+"'>"+i.columns[a].header+"</td>");i.columns[a].width&&o.width(i.columns[a].width),l.selectBox.table.headrow.append(o)}}var n=[];i.emptyText&&(l.emptyRow={},l.emptyRow[i.textField]=i.emptyText,l.emptyRow[i.valueField]=void 0!=i.emptyValue?i.emptyValue:"",t.splice(0,0,l.emptyRow));for(var s=0;s<t.length;s++){var r=t[s][i.valueField],d=t[s][i.textField],c=!!e.isFunction(i.isRowReadOnly)&&i.isRowReadOnly(t[s]);if(i.columns){n.push("<tr value='"+r+"'"),c&&n.push(" class='rowreadonly'"),n.push(">"),n.push("<td style='width:18px;'  index='"+s+"' value='"+r+"' text='"+d+"' ><input type='checkbox' /></td>");for(var a=0;a<i.columns.length;a++){var u=i.columns[a].name;n.push("<td>"+t[s][u]+"</td>")}n.push("</tr>")}else{n.push("<tr value='"+r+"'");var h=[];c&&h.push(" rowreadonly "),e.isFunction(i.rowClsRender)&&h.push(i.rowClsRender(t[s])),h.length&&(n.push(" class='"),n.push(h.join("")),n.push("'")),n.push(">"),i.isShowCheckBox&&n.push("<td style='width:18px;'  index='"+s+"' value='"+r+"' text='"+d+"' ><input type='checkbox' /></td>");var g=d;g=i.renderItem?i.renderItem.call(l,{data:t[s],value:r,text:d,key:l.inputText.val()}):i.autocomplete&&i.highLight?l._highLight(d,l.inputText.val()):"<span>"+g+"</span>",n.push("<td index='"+s+"' value='"+r+"' text='"+d+"' align='left'>"+g+"</td></tr>")}}i.columns?l.selectBox.table.append(n.join("")):i.isShowCheckBox?e("table.l-table-checkbox",l.selectBox).append(n.join("")):e("table.l-table-nocheckbox",l.selectBox).append(n.join("")),i.addRowButton&&i.addRowButtonClick&&!l.addRowButton&&(l.addRowButton=e('<div class="l-box-select-add"><a href="javascript:void(0)" class="link"><div class="icon"></div></a></div>'),l.addRowButton.find(".link").append(i.addRowButton).click(i.addRowButtonClick),l.selectBoxInner.after(l.addRowButton)),l.set("selectBoxHeight",i.selectBoxHeight),i.isShowCheckBox&&e.fn.ligerCheckBox&&e("table input:checkbox",l.selectBox).ligerCheckBox(),e(".l-table-checkbox input:checkbox",l.selectBox).change(function(){if(this.checked&&l.hasBind("beforeSelect")){var t=null;if(null!=(t="div"==e(this).parent().get(0).tagName.toLowerCase()?e(this).parent().parent():e(this).parent())&&0==l.trigger("beforeSelect",[t.attr("value"),t.attr("text")]))return l.selectBox.slideToggle("fast"),!1}i.isMultiSelect||this.checked&&(e("input:checked",l.selectBox).not(this).each(function(){this.checked=!1,e(".l-checkbox-checked",e(this).parent()).removeClass("l-checkbox-checked")}),l.selectBox.slideToggle("fast")),l._checkboxUpdateValue()}),e("table.l-table-nocheckbox td",l.selectBox).hover(function(){e(this).parent().hasClass("rowreadonly")||e(this).addClass("l-over")},function(){e(this).removeClass("l-over")}),l._addClickEven(),i.autocomplete||l.updateStyle(),l.trigger("afterShowData",[t])}},setTree:function(t){var l=this,i=this.options;this.clearContent(),l.selectBox.table.remove(),0!=t.checkbox?t.onCheck=function(){var t=l.treeManager.getChecked(),a=[],o=[];e(t).each(function(e,t){i.treeLeafOnly&&t.data.children||(a.push(t.data[i.valueField]),o.push(t.data[i.textField]))}),l._changeValue(a.join(i.split),o.join(i.split),!0)}:(t.onSelect=function(e){if(!(0==l.trigger("BeforeSelect",[e])||i.treeLeafOnly&&e.data.children)){var t=e.data[i.valueField],a=e.data[i.textField];l._changeValue(t,a,!0),l.selectBox.hide()}},t.onCancelSelect=function(e){l._changeValue("","",!0)}),t.onAfterAppend=function(e,t){if(l.treeManager){var a=null;i.initValue?a=i.initValue:""!=l.valueField.val()&&(a=l.valueField.val()),l.selectValueByTree(a)}},l.tree=e("<ul></ul>"),e("div:first",l.selectBox).append(l.tree),l.innerTree=l.tree.ligerTree(t),l.treeManager=l.tree.ligerGetTreeManager()},getTree:function(){return this.innerTree},selectValueByTree:function(e){var t=this,l=this.options;if(null!=e){var i=t.treeSelectInit(e);t._changeValue(e,i,l.initIsTriggerEvent)}},treeSelectInit:function(t){var l=this,i=this.options;if(null!=t){var a="",o=t.toString().split(i.split);return e(o).each(function(e,t){l.treeManager.selectNode(t.toString(),!1),a+=l.treeManager.getTextByID(t),e<o.length-1&&(a+=i.split)}),a}},setGrid:function(t){var l=this,i=this.options;if(!l.grid){i.hideOnLoseFocus=!!i.hideGridOnLoseFocus,this.clearContent(),l.selectBox.addClass("l-box-select-lookup"),l.selectBox.table.remove();var a=e("div:first",l.selectBox),o=e("<div></div>").appendTo(a),n=e("<div></div>").appendTo(a);if(l.conditionPanel=o,i.condition){var s=e.extend({labelWidth:60,space:20,width:i.selectBoxWidth},i.condition);l.condition=o.ligerForm(s)}else o.remove();t=e.extend({columnWidth:120,alternatingRow:!1,frozen:!0,rownumbers:!0,allowUnSelectRow:!0},t,{width:"100%",height:l.getGridHeight(),inWindow:!1,parms:i.parms,isChecked:function(t){var a=l.getValue();return!!a&&(!(!i.valueField||!t[i.valueField])&&-1!=e.inArray(t[i.valueField].toString(),a.split(i.split)))}}),l.grid=l.gridManager=n.ligerGrid(t),l.grid.bind("afterShowData",function(){l.updateSelectBoxPosition()});var r=[],d=function(){var a=[],o=[];e(r).each(function(e,t){a.push(t[i.valueField]),o.push(t[i.textField])}),t.checkbox?l.selected=r:r.length?l.selected=r[0]:l.selected=null,l._changeValue(a.join(i.split),o.join(i.split),!0),l.trigger("gridSelect",{value:a.join(i.split),text:o.join(i.split),data:r})},c=function(e){for(var t=r.length-1;t>=0;t--)r[t][i.valueField]==e[i.valueField]&&r.splice(t,1)},u=function(e){for(var t=r.length-1;t>=0;t--)if(r[t][i.valueField]==e[i.valueField])return;r.push(e)};if(t.checkbox){var h=function(e,t){e&&u(t),!e&&c(t)};l.grid.bind("CheckAllRow",function(t){e(l.grid.rows).each(function(e,l){h(t,l)}),d()}),l.grid.bind("CheckRow",function(e,t){h(e,t),d()})}else l.grid.bind("SelectRow",function(e){r=[e],d(),l._toggleSelectBox(!0)}),l.grid.bind("UnSelectRow",function(){r=[],d()});if(l.bind("show",function(){l.grid.refreshSize()}),l.bind("clear",function(){r=[],l.grid.selecteds=[],l.grid._showData()}),i.condition){var g=e('<li style="margin-right:9px"><div></div></li>'),p=e('<li style="margin-right:9px;float:right"><div></div></li>');e("ul:first",o).append(g).append(p).after('<div class="l-clear"></div>'),e("div",g).ligerButton({text:i.Search,width:40,click:function(){var a=l.condition.toConditions();i.conditionSearchClick?i.conditionSearchClick({grid:l.grid,rules:a}):l.grid.get("url")?(l.grid.setParm(t.conditionParmName||"condition",e.ligerui.toJSON(a)),l.grid.reload()):l.grid.loadData(e.ligerFilter.getFilterFunction(a))}}),e("div",p).ligerButton({text:"关闭",width:40,click:function(){l.selectBox.hide()}})}l.grid.refreshSize()}},getGridHeight:function(e){var t=this;this.options;return e=e||t.selectBox.height(),e-=t.conditionPanel.height()},_getValue:function(){var t=this;return this.options.isTextBoxMode?t.inputText.val():e(this.valueField).val()},getValue:function(){return this._getValue()},getSelected:function(){return this.selected},upFocus:function(){var t=this;this.options;if(t.grid){if(!t.grid.rows||!t.grid.rows.length)return;var l=t.grid.getSelected();if(l){var i=e.inArray(l,t.grid.rows);i-1<t.grid.rows.length&&(t.grid.unselect(l),t.grid.select(t.grid.rows[i-1]))}else t.grid.select(t.grid.rows[0])}else{var a=t.selectBox.table.find("td.l-over").attr("index");if(void 0==a||"0"==a)return;a=parseInt(a)-1,t.selectBox.table.find("td.l-over").removeClass("l-over"),t.selectBox.table.find("td[index="+a+"]").addClass("l-over"),t._scrollAdjust(a)}},downFocus:function(){var t=this;this.options;if(t.grid){if(!t.grid.rows||!t.grid.rows.length)return;var l=t.grid.getSelected();if(l){var i=e.inArray(l,t.grid.rows);i+1<t.grid.rows.length&&(t.grid.unselect(l),t.grid.select(t.grid.rows[i+1]))}else t.grid.select(t.grid.rows[0])}else{var a=t.selectBox.table.find("td.l-over").attr("index");if(a==t.data.length-1)return;a=void 0==a?0:parseInt(a)+1,t.selectBox.table.find("td.l-over").removeClass("l-over"),t.selectBox.table.find("td[index="+a+"]").addClass("l-over"),t._scrollAdjust(a)}},_scrollAdjust:function(t){var l=this,i=(this.options,e(".l-box-select-inner",l.selectBox).height()),a=e(".l-box-select-inner table",l.selectBox).height();if(!(a<=i)){var o=(parseInt(a/i),a/l.data.length),n=parseInt((t+1)*o/i)+((t+1)*o%i?1:0);e(".l-box-select-inner",l.selectBox).scrollTop((n-1)*i)}},getText:function(){return this.inputText.val()},setText:function(e){var t=this;this.options.isTextBoxMode||t.inputText.val(e)},updateStyle:function(){var e=this;this.options.initValue=e._getValue(),e._dataInit()},_dataInit:function(){var t=this,l=this.options,i=null;if(null!=l.initValue&&null!=l.initText&&t._changeValue(l.initValue,l.initText),null!=l.initValue){if(i=l.initValue,l.tree)i&&t.selectValueByTree(i);else if(t.data){var a=t.findTextByValue(i);t._changeValue(i,a)}}else if(""!=t.valueField.val())if(i=t.valueField.val(),l.tree)i&&t.selectValueByTree(i);else if(t.data){var a=t.findTextByValue(i);t._changeValue(i,a)}l.isShowCheckBox?e(":checkbox",t.selectBox).each(function(){var t=null,a=e(this);if(null!=(t="div"==a.parent().get(0).tagName.toLowerCase()?a.parent().parent():a.parent())){e(".l-checkbox",t).removeClass("l-checkbox-checked"),a[0].checked=!1;var o=(i||"").toString().split(l.split);e(o).each(function(l,o){null!=i&&o==t.attr("value")&&(e(".l-checkbox",t).addClass("l-checkbox-checked"),a[0].checked=!0)})}}):e("table tr",t.selectBox).find("td:first").each(function(){null!=i&&i==e(this).attr("value")?e(this).addClass("l-selected"):e(this).removeClass("l-selected")})},_changeValue:function(t,l,i){var a=this,o=this.options;a.valueField.val(t),o&&o.render?a.inputText.val(o.render(t,l)):a.inputText.val(l),a.select&&e("option",a.select).each(function(){e(this).attr("selected",e(this).attr("value")==t)}),a.selectedValue=t,a.selectedText=l,a.inputText.trigger("change"),i&&l&&a.inputText.focus();var n=null;if(t&&"string"==typeof t&&t.indexOf(o.split)>-1){n=[];var s=t.split(o.split);e(s).each(function(e,t){n.push(a.getRow(t))})}else t&&(n=a.getRow(t));i&&a.trigger("selected",[t,l,n])},_checkboxUpdateValue:function(){var t=this,l=this.options,i="",a="";e("input:checked",t.selectBox).each(function(){var t=null;(t="div"==e(this).parent().get(0).tagName.toLowerCase()?e(this).parent().parent():e(this).parent())&&(i+=t.attr("value")+l.split,a+=t.attr("text")+l.split)}),i.length>0&&(i=i.substr(0,i.length-1)),a.length>0&&(a=a.substr(0,a.length-1)),t._changeValue(i,a)},loadDetail:function(t,l){var i=this,a=this.options,o=e.isFunction(a.detailParms)?a.detailParms.call(i):a.detailParms;o[a.detailPostIdField||"id"]=t,"application/json"==a.ajaxContentType&&(o=liger.toJSON(o));var n={type:a.ajaxType,url:a.detailUrl,data:o,cache:!0,dataType:"json",beforeSend:a.ajaxBeforeSend,complete:a.ajaxComplete,success:function(t){var i=e.isFunction(a.detailDataGetter)?a.detailDataGetter(t):t;i=a.detailDataParmName?i[a.detailDataParmName]:i,l&&l(i)}};a.ajaxContentType&&(n.contentType=a.ajaxContentType),e.ajax(n)},enabledLoadDetail:function(){var e=this.options;return!(!e.detailUrl||!e.detailEnabled)},_addClickEven:function(){var t=this,l=this.options;e(".l-table-nocheckbox td",t.selectBox).click(function(){function i(){return t.hasBind("beforeSelect")&&0==t.trigger("beforeSelect",[o,r,s])?(l.slide?t.selectBox.slideToggle("fast"):t.selectBox.hide(),!1):(t.selected=s,e(this).hasClass("l-selected")?void(l.slide?t.selectBox.slideToggle("fast"):t.selectBox.hide()):(e(".l-selected",t.selectBox).removeClass("l-selected"),a.addClass("l-selected"),t.select&&t.select[0].selectedIndex!=n&&(t.select[0].selectedIndex=n,t.select.trigger("change")),l.slide?(t.boxToggling=!0,t.selectBox.hide("fast",function(){t.boxToggling=!1})):t.selectBox.hide(),t.lastInputText=r,void t._changeValue(o,r,!0)))}var a=e(this),o=a.attr("value"),n=parseInt(e(this).attr("index")),s=t.data[n],r=a.attr("text");a.parent().hasClass("rowreadonly")||(t.enabledLoadDetail()?t.loadDetail(o,function(e){t.data[n]=s=e,i()}):i())})},updateSelectBoxPosition:function(){var t=this,l=this.options;if(l&&l.absolute){var i=e(document).height();l.alwayShowInTop||Number(t.wrapper.offset().top+1+t.wrapper.outerHeight()+t.selectBox.height())>i&&i>Number(t.selectBox.height()+1)?t.selectBox.css({left:t.wrapper.offset().left,top:t.wrapper.offset().top-1-t.selectBox.height()+(l.selectBoxPosYDiff||0)}):t.selectBox.css({left:t.wrapper.offset().left,top:t.wrapper.offset().top+1+t.wrapper.outerHeight()+(l.selectBoxPosYDiff||0)}),l.alwayShowInDown&&t.selectBox.css({left:t.wrapper.offset().left,top:t.wrapper.offset().top+1+t.wrapper.outerHeight()})}else{var a=t.wrapper.offset().top-e(window).scrollTop(),o=t.selectBox.height()+textHeight+4;a+o>e(window).height()&&a>o&&t.selectBox.css("marginTop",-1*(t.selectBox.height()+textHeight+5)+(l.selectBoxPosYDiff||0))}},_toggleSelectBox:function(t){var l=this,i=this.options;if(l&&i){for(var a=e.ligerui.find(e.ligerui.controls.ComboBox),o=0,n=a.length;o<n;o++){var s=a[o];s.id!=l.id&&null!=s.selectBox.is(":visible")&&s.selectBox.is(":visible")&&s.selectBox.hide()}a=e.ligerui.find(e.ligerui.controls.DateEditor);for(var o=0,n=a.length;o<n;o++){var s=a[o];s.id!=l.id&&null!=s.dateeditor.is(":visible")&&s.dateeditor.is(":visible")&&s.dateeditor.hide()}l.wrapper.height();if(l.boxToggling=!0,t)i.slide?l.selectBox.slideToggle("fast",function(){l.boxToggling=!1}):(l.selectBox.hide(),l.boxToggling=!1);else if(l.updateSelectBoxPosition(),i.slide)l.selectBox.slideToggle("fast",function(){if(l.boxToggling=!1,!i.isShowCheckBox&&e("td.l-selected",l.selectBox).length>0){var t=e("td.l-selected",l.selectBox).offset().top-l.selectBox.offset().top;e(".l-box-select-inner",l.selectBox).animate({scrollTop:t})}});else if(l._selectBoxShow(),l.boxToggling=!1,!l.tree&&!l.grid&&!i.isShowCheckBox&&e("td.l-selected",l.selectBox).length>0){var r=e("td.l-selected",l.selectBox).offset().top-l.selectBox.offset().top;e(".l-box-select-inner",l.selectBox).animate({scrollTop:r})}l.isShowed=l.selectBox.is(":visible"),l.trigger("toggle",[t]),l.trigger(t?"hide":"show")}},_selectBoxShow:function(){var e=this,t=this.options;if(!t.readonly)return t.grid||t.tree?void e.selectBox.show():void(e.selectBox.table.find("tr").length||t.selectBoxRender&&e.selectBoxInner.html()?e.selectBox.show():e.selectBox.hide())},_highLight:function(e,t){if(!e)return e;var l=e.indexOf(t);return-1==l?e:e.substring(0,l)+"<span class='l-highLight'>"+t+"</span>"+e.substring(t.length+l)},_setAutocomplete:function(t){var l=this,i=this.options;t&&(i.readonly||(l.inputText.removeAttr("readonly"),l.lastInputText=l.inputText.val(),l.inputText.keyup(function(a){38!=a.keyCode&&40!=a.keyCode&&13!=a.keyCode&&(this._acto&&clearTimeout(this._acto),this._acto=setTimeout(function(){if(l.lastInputText!=l.inputText.val()){var a=l.inputText.val();if(a?a=a.replace(/(^\s*)|(\s*$)/g,""):(i.initValue="",l.valueField.val("")),l.lastInputText=l.inputText.val(),e.isFunction(t))return void t.call(l,{key:a,show:function(){l._selectBoxShow()}});if(!i.autocompleteAllowEmpty&&!a)return l.clear(),void l.selectBox.hide();i.url?(l.setParm("key",a),l.setUrl(i.url,function(){l._selectBoxShow()})):i.grid&&(l.grid.setParm("key",a),l.grid.reload()),this._acto=null}},300))})))}}),e.ligerui.controls.ComboBox.prototype.setValue=e.ligerui.controls.ComboBox.prototype.selectValue,e.ligerui.controls.ComboBox.prototype.setInputValue=e.ligerui.controls.ComboBox.prototype._changeValue,function(){e(document).unbind("keydown.ligercombobox"),e(document).bind("keydown.ligercombobox",function(t){function l(){o.selectBox.is(":visible")||o.selectBox.show(),o.downFocus()}function i(){s?(o._changeValue(s[n.valueField],s[n.textField],!0),o.selectBox.hide(),o.trigger("textBoxKeyEnter",[{rowdata:s}])):(o._changeValue(d,r.attr("text"),!0),o.selectBox.hide(),o.trigger("textBoxKeyEnter",[{element:r.get(0)}]))}var a=e("input:focus");if(a.length&&a.attr("data-comboboxid")){var o=liger.get(a.attr("data-comboboxid"));if(!o)return;var n=o.options;if(!o.get("keySupport"))return;if(38==t.keyCode)o.upFocus();else if(40==t.keyCode)o.hasBind("textBoxKeyDown")?o.trigger("textBoxKeyDown",[{callback:function(){l()}}]):l();else if(13==t.keyCode){if(!o.selectBox.is(":visible"))return;var s=null;o.grid&&(s=o.grid.getSelected());var r=o.selectBox.table.find("td.l-over");if(s||r.length){var d=r.attr("value");s&&s.ID&&(d=s.ID),o.enabledLoadDetail()?o.loadDetail(d,function(e){if(!s){
var t=o.getRowIndex(d);if(-1==t)return;o.data=o.data||[],o.data[t]=o.selected=e}i()}):i()}}}})}()}(jQuery);