!function(e){e.fn.ligerPopupEdit=function(t){return e.ligerui.run.call(this,"ligerPopupEdit",arguments)},e.fn.ligerGetPopupEditManager=function(){return e.ligerui.run.call(this,"ligerGetPopupEditManager",arguments)},e.ligerDefaults.PopupEdit={valueFieldID:null,css:null,onButtonClick:null,nullText:null,disabled:!1,method:"post",async:!0,cancelable:!0,width:200,heigth:null,render:null,split:";",data:[],grid:null,condition:null,valueField:"id",textField:"text",parms:null,onSelect:null,onSelected:null,valueFieldCssClass:null,searchClick:null},e.ligerMethos.PopupEdit=e.ligerMethos.PopupEdit||{},e.ligerui.controls.PopupEdit=function(t,i){e.ligerui.controls.PopupEdit.base.constructor.call(this,t,i)},e.ligerui.controls.PopupEdit.ligerExtend(e.ligerui.controls.Input,{__getType:function(){return"PopupEdit"},_extendMethods:function(){return e.ligerMethos.PopupEdit},_init:function(){e.ligerui.controls.PopupEdit.base._init.call(this)},_render:function(){var t=this,i=this.options;t.inputText=null,"input"==this.element.tagName.toLowerCase()&&(this.element.readOnly=!0,t.inputText=e(this.element),t.textFieldID=this.element.id),void 0==t.inputText[0].name&&(t.inputText[0].name=t.textFieldID),t.valueField=null,i.valueFieldID?(t.valueField=e("#"+i.valueFieldID+":input"),0==t.valueField.length&&(t.valueField=e('<input type="hidden"/>')),void 0==t.valueField[0].name&&(t.valueField[0].id=t.valueField[0].name=i.valueFieldID)):(t.valueField=e('<input type="hidden"/>'),t.valueField[0].id=t.valueField[0].name=t.textFieldID+"_val"),void 0==t.valueField[0].name&&(t.valueField[0].name=t.valueField[0].id),i.valueFieldCssClass&&t.valueField.addClass(i.valueFieldCssClass),t.link=e('<div class="l-trigger"><div class="l-trigger-icon"></div></div>'),t.wrapper=t.inputText.wrap('<div class="l-text l-text-popup"></div>').parent(),t.wrapper.append('<div class="l-text-l"></div><div class="l-text-r"></div>'),t.wrapper.append(t.link),t.wrapper.append(t.valueField),t.valueField.attr("data-ligerid",t.id),t.inputText.addClass("l-text-field"),t.link.hover(function(){i.disabled||(this.className="l-trigger-hover")},function(){i.disabled||(this.className="l-trigger")}).mousedown(function(){i.disabled||(this.className="l-trigger-pressed")}).mouseup(function(){i.disabled||(this.className="l-trigger-hover")}).click(function(){if(!i.disabled)return 0!=t.trigger("buttonClick")&&void 0}),t.inputText.click(function(){i.disabled}).blur(function(){i.disabled||t.wrapper.removeClass("l-text-focus")}).focus(function(){i.disabled||t.wrapper.addClass("l-text-focus")}),t.wrapper.hover(function(){i.disabled||t.wrapper.addClass("l-text-over")},function(){i.disabled||t.wrapper.removeClass("l-text-over")}),t.set(i),t.setTextByVal(t.getValue())},destroy:function(){this.wrapper&&this.wrapper.remove(),this.options=null,e.ligerui.remove(this)},clear:function(){var e=this;this.options;e.inputText.val(""),e.valueField.val("")},_setCss:function(e){e&&this.wrapper.addClass(e)},_setCancelable:function(t){var i=this,l=this.options;!t&&i.unselect&&(i.unselect.remove(),i.unselect=null),(t||i.unselect)&&(i.unselect=e('<div class="l-trigger l-trigger-cancel"><div class="l-trigger-icon"></div></div>').hide(),i.wrapper.hover(function(){i.unselect.show()},function(){i.unselect.hide()}),!l.disabled&&l.cancelable&&i.wrapper.append(i.unselect),i.unselect.hover(function(){this.className="l-trigger-hover l-trigger-cancel"},function(){this.className="l-trigger l-trigger-cancel"}).click(function(){i.clear()}))},_setDisabled:function(e){e?this.wrapper.addClass("l-text-disabled"):this.wrapper.removeClass("l-text-disabled")},_setWidth:function(e){var t=this;e>20&&(t.wrapper.css({width:e}),t.inputText.css({width:e-20}))},_setHeight:function(e){var t=this;e>10&&(t.wrapper.height(e),t.inputText.height(e-2))},getData:function(){var t=this,i=this.options,l=[],n=e(t.valueField).val(),a=e(t.inputText).val(),s=n?n.split(i.split):null,r=a?a.split(i.split):null;return e(s).each(function(e){var t={};t[i.textField]=r[e],t[i.valueField]=s[e],l.push(t)}),l},_getText:function(){return e(this.inputText).val()},_getValue:function(){return e(this.valueField).val()},getValue:function(){return this._getValue()},getText:function(){return this._getText()},setValue:function(e,t){if(""!=e){var i=this;this.options;if(arguments.length>=2)return i.setValue(e),void i.setText(t);i.valueField.val(e)}},setTextByVal:function(t){if(""!=(t="string"!=typeof t?t.toString:t)){var i=this,l=[],n=this.options,a=[];i.valueField.val()!=t&&i.valueField.val(t);var s=n.grid;e.isFunction(s)&&(s=s());var r=e.extend({parms:n.parms},s);if(n.data.length>0)a=n.data.Rows;else{if(r.url)return void i.loadServerData(r.url,t);a=r.data.Rows}var u=t.split(n.split);e(a).each(function(t,i){-1!=e.inArray(i[n.valueField],u)&&l.push(i[n.textField])}),l=l.join(n.split),i.setText(l)}},loadServerData:function(t,i){var l=this,n=this.options;e.isFunction(t)&&(t=t());var a={type:n.method,url:t,async:n.async,dataType:"json",success:function(t){gridData=e.extend(!0,{},t),n.data=gridData,gridData=t.Rows;var a=i.split(n.split),s=[];e(gridData).each(function(t,i){-1!=e.inArray(i[n.valueField],a)&&s.push(i[n.textField])}),s=s.join(n.split),l.setText(s)},error:function(e,t,i){}};e.ajax(a)},setText:function(e){var t=this,i=this.options;i.render?t.inputText.val(i.render(e)):t.inputText.val(e)},addValue:function(t,i){var l=this,n=this.options;if(t){var a=l.getValue(),s=l.getText();if(a){for(var r=[],u=[],o=a.split(n.split),t=t.split(n.split),i=i.split(n.split),d=0,c=t.length;d<c;d++)-1==e.inArray(t[d],o)&&(r.push(t[d]),u.push(i[d]));r.length&&(l.setValue(a+n.split+r.join(n.split)),l.setText(s+n.split+u.join(n.split)))}else l.setValue(t),l.setText(i)}},removeValue:function(t,i){var l=this,n=this.options;if(t){var a=l.getValue(),s=l.getText();if(a){for(var r=a.split(n.split),u=s.split(n.split),t=t.split(n.split),o=0,d=-1,c=t.length;o<c;o++)-1!=(d=e.inArray(t[o],r))&&(r.splice(d,1),u.splice(d,1));l.setValue(r.join(n.split)),l.setText(u.join(n.split))}}},_setGrid:function(t){if(t){var i=this,l=this.options,n=e.extend({parms:l.parms},l.grid);this.bind("buttonClick",function(){if(!i.popupFn){var t={grid:n,condition:l.condition,valueField:l.valueField,textField:l.textField,split:l.split,searchClick:l.searchClick,lastSelected:function(){try{return i.getData()}catch(e){return null}}(),onSelect:function(e){0!=i.trigger("select",e)&&(l.grid.checkbox?(i.addValue(e.value,e.text),i.removeValue(e.remvoeValue,e.remvoeText)):(i.setValue(e.value),i.setText(e.text)),i.trigger("selected",e))},selectInit:function(t){var n=i.getValue();return!!n&&(!(!l.valueField||!t[l.valueField])&&-1!=e.inArray(t[l.valueField].toString(),n.split(l.split)))}};i.popupFn=e.ligerui.getPopupFn(t,i)}i.popupFn()})}}}),e.ligerui.getPopupFn=function(t,i){function l(){function l(e){return e=e||t.height,e-=d.height()}if(s)return r._showData(),s.show(),r.refreshSize(),void(o=r.selected.concat());var n=e("<div></div>"),d=e("<div></div>"),c=e("<div></div>");if(n.append(d).append(c),t.condition){var p=e.extend({labelWidth:60,space:20},t.condition);setTimeout(function(){u=d.ligerForm(p)},50)}else d.remove();var v=e.extend({columnWidth:120,alternatingRow:!1,frozen:!0,rownumbers:!0},t.grid,{width:"100%",height:l(),isChecked:t.selectInit,isSelected:t.selectInit,inWindow:!1});r=c.ligerGrid(v),t.condition&&setTimeout(function(){var i=e('<li style="margin-right:9px"><div></div></li>');e("ul:first",d).append(i).after('<div class="l-clear"></div>'),e("div",i).ligerButton({text:"搜索",click:function(){var i=u.toConditions();t.searchClick?t.searchClick({grid:r,rules:i}):r.get("url")?(r.setParm(r.conditionParmName||"condition",e.ligerui.toJSON(i)),r.reload()):r.loadData(e.ligerFilter.getFilterFunction(i))}})},100),s=e.ligerDialog.open({title:t.title,width:t.width,height:"auto",top:t.top,left:t.left,target:n,isResize:!0,cls:"l-selectorwin",onContentHeightChange:function(e){return r.set("height",l(e)),!1},onStopResize:function(){r.refreshSize()},buttons:[{text:"选择",onclick:function(e,t){a(),t.hide()}},{text:"取消",onclick:function(e,t){t.hide()}}]}),i&&(i.includeControls=i.includeControls||[],i.includeControls.push(s)),r.refreshSize()}function n(e,i){for(var l=0;i&&i[l];l++){if(i[l][t.valueField]==e)return!0}return!1}function a(){var i=r.selected||[],l=[],a=[],s=[];e(i).each(function(i,n){t.valueField&&l.push(n[t.valueField]),t.textField&&a.push(n[t.textField]);var u=e.extend(!0,{},this);r.formatRecord(u,!0),s.push(u)});var u=[];e(o).each(function(e,l){!n(l[t.valueField],i)&&n(l[t.valueField],r.rows)&&u.push(l)});var d=[],c=[],p=[];e(u).each(function(i,l){t.valueField&&d.push(l[t.valueField]),t.textField&&c.push(l[t.textField]);var n=e.extend(!0,{},this);r.formatRecord(n,!0),p.push(n)}),t.onSelect({value:l.join(t.split),text:a.join(t.split),data:s,remvoeValue:d.join(t.split),remvoeText:c.join(t.split),removeData:p})}if(t=e.extend({title:"选择数据",width:700,height:320,top:null,left:null,split:";",valueField:null,textField:null,grid:null,condition:null,onSelect:function(e){},searchClick:t.searchClick,selectInit:function(e){return!1}},t),t.grid){var s,r,u,o=t.lastSelected||[];return function(){return l(),!1}}}}(jQuery);