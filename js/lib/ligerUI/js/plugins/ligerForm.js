!function($){function getInvalidInf(e){var t=[];return $(e).each(function(e,i){var a=$(i.element).parents("li:first").prev("li:first").html(),l=i.message;t.push("<div>"+a+" "+l+"</div>")}),t.join("")}$.fn.ligerForm=function(){return $.ligerui.run.call(this,"ligerForm",arguments)},$.ligerui.getConditions=function(e,t){return e?(e=liger.get($(e)),e&&e.toConditions?e.toConditions():void 0):null},$.ligerDefaults=$.ligerDefaults||{},$.ligerDefaults.Form={width:null,inputWidth:180,labelWidth:90,space:40,rightToken:"：",labelAlign:"left",align:"left",autoTypePrev:"ui-",fields:[],appendID:!0,prefixID:null,toJSON:$.ligerui.toJSON,labelCss:null,fieldCss:null,spaceCss:null,onAfterSetFields:null,buttons:null,readonly:!1,editors:{},validate:null,unSetValidateAttr:!1,tab:null,clsTab:"ui-tabs-nav ui-helper-clearfix",clsTabItem:"ui-state-default",clsTabItemSelected:"ui-tabs-selected",clsTabContent:"ui-tabs-panel ui-widget-content"},$.ligerDefaults.FormString={invalidMessage:"存在{errorCount}个字段验证不通过，请检查!",detailMessage:"详细",okMessage:"确定"},$.ligerDefaults.Form.editors.textarea={create:function(e,t,i){var a=$('<textarea class="l-textarea" />'),l=(i.prefixID||"")+t.field.name;return $("#"+l).length&&(a=$("#"+l)),a.attr({id:l,name:l}),t.field.editor&&t.field.editor.height&&a.height(t.field.editor.height),i.readonly&&a.attr("readonly",!0),e.append(a),a},getValue:function(e,t){return e.val()},setValue:function(e,t,i){e.val(t)},resize:function(e,t,i,a){e.css({width:t-2}).parent().css("width","auto")}},$.ligerDefaults.Form.editors.hidden={create:function(e,t,i){var a=$('<input type = "hidden"  />'),l=(i.prefixID||"")+t.field.name;$("#"+l).length&&(a=$("#"+l)),a.attr($.extend({id:l,name:l},t.field.attr));var r=t.field.editor||t.field.options;return r&&a.val(r.value),e.append(a),a},getValue:function(e,t){return e.val()},setValue:function(e,t,i){e.val(t)}},$.ligerDefaults.Form_fields={name:null,textField:null,type:null,editor:null,label:null,labelInAfter:!1,afterContent:null,beforeContent:null,hideSpace:!1,hideLabel:!1,rightToken:null,attrRender:null,style:null,containerCls:null,newline:!0,op:null,vt:null,attr:null,validate:null},$.ligerDefaults.Form_editor={},$.ligerDefaults.Form.editorBulider=function(e){var t=this.options;if(e&&e.length){var i={},a=e.attr("ltype"),l={};t.readonly&&(i.readonly=!0),i=$.extend({width:(l.width||t.inputWidth)-2},l.options,l.editor,i);var r=null;if("autocomplete"==a&&(i.autocomplete=!0),e.is("select")&&"none"!=a)r=e.ligerComboBox(i);else if(e.is(":password")&&"none"!=a)r=e.ligerTextBox(i);else if(e.is(":radio")&&"none"!=a)r=e.ligerRadio(i);else if(e.is(":checkbox")&&"none"!=a)r=e.ligerCheckBox(i);else if(e.is("textarea")&&"none"!=a)e.addClass("l-textarea"),r={getValue:function(){return e.val()},setValue:function(t){e.val(t)}};else if(a&&"none"!=a){if(e.is(":text"))switch(a){case"select":case"combobox":case"autocomplete":r=e.ligerComboBox(i);break;case"spinner":r=e.ligerSpinner(i);break;case"date":r=e.ligerDateEditor(i);break;case"popup":r=e.ligerPopupEdit(i);break;case"currency":r=i.currency=!0;case"float":case"number":i.number=!0,r=e.ligerTextBox(i);break;case"int":case"digits":i.digits=!0;default:r=e.ligerTextBox(i)}else if(e.is(":hidden"))switch(a){case"select":case"combobox":case"autocomplete":r=e.ligerComboBox(i);break;case"checkboxlist":r=e.ligerCheckBoxList(i);break;case"radiolist":r=e.ligerRadioList(i);break;case"listbox":r=e.ligerListBox(i)}}else{var s=e.get(0).className;if(s){var n=t.autoTypePrev||"ui-";-1!=s.indexOf(n)&&(s=s.replace(n,""))}if(!s&&(e.is(":hidden")||e.is(":text"))&&e.attr("name"))r={getValue:function(){return e.val()},setValue:function(t){e.val(t)}};else switch(s){case"textbox":case"password":r=e.ligerTextBox(i);break;case"datepicker":r=e.ligerDateEditor(i);break;case"spinner":r=e.ligerSpinner(i);break;case"checkbox":r=e.ligerCheckBox(i);break;case"combobox":r=e.ligerComboBox(i);break;case"checkboxlist":r=e.ligerCheckBoxList(i);break;case"radiolist":r=e.ligerRadioList(i);break;case"listbox":r=e.ligerListBox(i)}}return r?{name:e.attr("name"),control:r}:null}},$.ligerui.controls.Form=function(e,t){$.ligerui.controls.Form.base.constructor.call(this,e,t)},$.ligerui.controls.Form.ligerExtend($.ligerui.core.UIComponent,{__getType:function(){return"Form"},__idPrev:function(){return"Form"},_init:function(){var e=this,t=this.options;$.ligerui.controls.Form.base._init.call(this);for(var i in liger.editors){var a=liger.editors[i];!a||i in t.editors||(t.editors[i]=liger.getEditor($.extend({type:i,master:e},a)))}},_render:function(){var g=this,p=this.options,jform=$(this.element);if(g.form=jform.is("form")?jform:jform.parents("form:first"),$("input,select,textarea",jform).each(function(){var e=p.editorBulider.call(g,$(this));e&&(g.autoEditors=g.autoEditors||[],g.autoEditors.push(e))}),g.autoEditors&&g.autoEditors.length&&p.validate&&(g.validate=g.validate||{},$(g.autoEditors).each(function(){var name=this.name,control=this.control;if(name&&control.inputText&&control.inputText.attr("validate")){var v=null,vm=null;eval("v = "+control.inputText.attr("validate")),v&&(g.validate.rules=g.validate.rules||{},g.validate.rules[name]=v),control.inputText.attr("validateMessage")&&(eval("vm = "+control.inputText.attr("validateMessage")),vm&&(g.validate.messages=g.validate.messages||{},g.validate.messages[name]=vm))}})),g.set(p),g.initValidate(),p.buttons){var jbuttons=$('<ul class="l-form-buttons"></ul>').appendTo(jform);$(p.buttons).each(function(){var e=$("<li><div></div></li>").appendTo(jbuttons);$("div:first",e).ligerButton(this)})}g.element.id||(g.element.id=g.id),$("#"+g.element.id+" .togglebtn").live("click",function(){$(this).hasClass("togglebtn-down")?$(this).removeClass("togglebtn-down"):$(this).addClass("togglebtn-down");for(var e=$(this).parent().nextAll("ul,div"),t=0;t<e.length;t++){var i=$(e[t]);if(i.hasClass("l-group"))break;$(this).hasClass("togglebtn-down")?i.hide():i.show()}})},_setWidth:function(e){var t=this;this.options;e&&t.form.width(e)},getEditor:function(e){function t(t,l){for(var r=null==t?a.fields:t.fields,s=0,n=r.length;s<n;s++){var o=r[s],d=null==l?s:"tab"+l+"_"+s;if(o.name==e&&i.editors[d])return i.editors[d].control}}var i=this,a=this.options;if(i.editors){var l=t(null);if(l)return l;if(a.tab&&a.tab.items)for(var r=0;r<a.tab.items.length;r++){var s=a.tab.items[r],l=t(s,r);if(l)return l}return null}},getField:function(e){var t=this.options;return t.fields?t.fields[e]:null},toConditions:function(){var e=this,t=this.options,i=[];return $(t.fields).each(function(t,a){var l=a.name,r=(a.textField,e.editors[t]);if(r&&l){var s=r.editor.getValue.call(e,r.control,{field:a});null!=s&&""!==s&&i.push({op:a.operator||"like",field:l,value:s,type:a.type||"string"})}}),i},_preSetFields:function(e){var t=this.options,i=null,a=null;$(t.fields).each(function(e,l){(t.readonly||l.readonly||l.editor&&l.editor.readonly)&&delete l.validate,"hidden"!=l.type&&(l.type=l.type||"text",null==l.newline&&(l.newline=!0),i&&!l.group&&(l.group=i,l.groupicon=a),l.group&&(l.group=l.group.toString().replace(/^\s\s*/,"").replace(/\s\s*$/,""),i=l.group,a=l.groupicon))})},_setReadonly:function(e){var t=this;this.options;if(e&&t.editors)for(var i in t.editors){var a=t.editors[i].control;a&&a._setReadonly&&a._setReadonly(!0)}},_setFields:function(e){var t=this,i=this.options;$.isFunction(i.prefixID)&&(i.prefixID=i.prefixID(t));var a=$(t.element).addClass("l-form");t._initFieldsValidate({fields:e}),t._initFieldsHtml({panel:a,fields:e}),t._createEditors({fields:e}),t.trigger("afterSetFields")},_initFieldsValidate:function(e){var t=this,i=this.options,a=e.fields;t.validate=t.validate||{},a&&a.length&&$(a).each(function(e,a){var l=(a.name,!!(a.readonly||a.editor&&a.editor.readonly)),r=(i.prefixID||"")+(a.textField||a.id||a.name);a.validate&&!l&&(t.validate.rules=t.validate.rules||{},t.validate.rules[r]=a.validate,a.validateMessage&&(t.validate.messages=t.validate.messages||{},t.validate.messages[r]=a.validateMessage))})},_initFieldsHtml:function(e){var t=this,i=this.options,a=e.panel,l=e.fields,r=e.idPrev||t.id,s=e.tabindex;$(">.l-form-container",a).remove();var n=0,o=0;if(l&&l.length){t._preSetFields(l);var d=['<div class="l-form-container">'],u=!1,c=null,f=[];$(l).each(function(e,t){t.group||(t.group=""),-1==$.inArray(t.group,f)&&f.push(t.group)}),$(f).each(function(a,f){$(l).each(function(a,h){if(h.group==f){var p=$.inArray(h,l),v=h.id||h.name,g=h.newline,m=(i.prefixID||"")+(h.id||h.name);if(v){if("hidden"==h.type)return void($("#"+m).length||d.push('<div style="display:none" id="'+r+"|"+a+'"></div>'));var b=h.group&&h.group!=c;if((0==p||b)&&(g=!0),g&&(n=0,u&&(d.push("</ul>"),u=!1),b&&(d.push('<div class="l-group'),h.groupicon&&d.push(" l-group-hasicon"),d.push('">'),h.groupicon&&d.push('<img src="'+h.groupicon+'" />'),d.push("<span>"+h.group+"</span></div>"),c=h.group),d.push("<ul>"),u=!0),d.push('<li class="l-fieldcontainer'),g&&d.push(" l-fieldcontainer-first"),h.containerCls&&d.push(" "+h.containerCls),d.push('"'),h.style&&d.push(' style="'+h.style+'"'),d.push(' fieldindex="'+p+'"'),null!=s&&d.push(' tabindex="'+s+'"'),h.attrRender&&d.push(" "+h.attrRender()),d.push("><ul>"),h.beforeContent){var x=$.isFunction(h.beforeContent)?h.afterContent(h):h.beforeContent;x&&d.push(x)}if(h.hideLabel||h.labelInAfter||d.push(t._buliderLabelContainer(h,p)),d.push(t._buliderControlContainer(h,p,e.idPrev)),h.labelInAfter&&d.push(t._buliderLabelContainer(h,p)),h.afterContent){var C=$.isFunction(h.afterContent)?h.afterContent(h):h.afterContent;C&&d.push(C)}h.hideSpace||d.push(t._buliderSpaceContainer(h,p)),d.push("</ul></li>"),n+=h.width||i.inputWidth||0,n+=h.space||i.space||0,n+=h.labelWidth||i.labelWidth||0,n>o&&(o=n)}}})}),u&&(d.push("</ul>"),u=!1),d.push('<div class="l-clear"></div>'),d.push("</div>"),a.append(d.join("")),!i.width||i.width,$(".l-group .togglebtn",a).remove(),$(".l-group",a).width(.95*a.width()).append("<div class='togglebtn'></div>")}},_createEditors:function(e){var t=this,i=this.options,a=e.fields,l=e.idPrev||t.id,r=e.editPrev||"";t.editors=t.editors||{};$(t.element);$(a).each(function(e,a){var s=document.getElementById(l+"|"+e),n=i.editors[a.type],o=r+e;if(s){s=$(s);var d=t._createEditor(n,s,{field:a},s.width(),s.height());d&&(t.editors[o]&&t.editors[o].control&&t.editors[o].control.destroy&&t.editors[o].control.destroy(),t.editors[o]={control:d,editor:n})}})},getChanges:function(){var e=this,t=(this.options,e.data),i=e.getData();e.data=t;var a={};for(var l in t)i[l]!=t[l]&&(a[l]=i[l]);return a},setEnabled:function(e,t){function i(e,i){$(e).each(function(e,r){var s=r.name,n=(r.textField,null==i?"":"tab"+i+"_"),o=l.editors[n+e];o&&s&&o.editor&&o.editor.setEnabled&&-1!=$.inArray(s,a)&&o.editor.setEnabled(o.control,t)})}var a=[];$.isArray(e)&&(a=e),"string"==typeof e&&a.push(e);var l=this,r=this.options;if(i(r.fields),r.tab&&r.tab.items)for(var s=0;s<r.tab.items.length;s++){var n=r.tab.items[s];i(n.fields,s)}},setVisible:function(e,t){function i(e,i){$(e).each(function(e,r){var s=r.name;-1!=$.inArray(s,a)&&l._setFieldPanelVisible(i,e,t)})}var a=[];$.isArray(e)&&(a=e),"string"==typeof e&&a.push(e);var l=this,r=this.options;if(i(r.fields),r.tab&&r.tab.items)for(var s=0;s<r.tab.items.length;s++){var n=r.tab.items[s];i(n.fields,s)}},_setFieldPanelVisible:function(e,t,i){var a=this,l=this.options;null==e?$("li.l-fieldcontainer[fieldindex="+t+"]",a.element)[i?"show":"hide"]():$("div."+l.clsTabContent+"[data-index="+e+"] li.l-fieldcontainer[fieldindex="+t+"]",a.element)[i?"show":"hide"]()},getData:function(){function e(e,i){$(e).each(function(e,a){var l=a.name,r=a.textField,s=null==i?"":"tab"+i+"_",n=t.editors[s+e];if(n){if(l){var o=n.editor.getValue.call(t,n.control,{field:a});t._setValueByName(t.data,l,o)}if(r&&n.editor.getText){var o=n.editor.getText.call(t,n.control,{field:a});t._setValueByName(t.data,r,o)}}})}var t=this,i=this.options;if(t.data=t.formData||{},t.autoEditors&&t.autoEditors.length&&$(t.autoEditors).each(function(){var e=this.name,i=this.control;e&&i&&i.getValue&&(t.data[e]=i.getValue())}),e(i.fields),i.tab&&i.tab.items)for(var a=0;a<i.tab.items.length;a++){var l=i.tab.items[a];e(l.fields,a)}return t.data},_setData:function(e){this.setData(e)},setData:function(e){function t(e,t){$(e).each(function(e,a){var l=a.name,r=a.textField,s=null==t?"":"tab"+t+"_",n=i.editors[s+e];if(n){if(l&&l in i.data){var o=i._getValueByName(i.data,l);n.editor.setValue.call(i,n.control,o,{field:a})}if(r&&r in i.data){var d=i._getValueByName(i.data,r);n.editor.setText.call(i,n.control,d,{field:a})}}})}var i=this,a=this.options;if(i.data=e||{},i.autoEditors&&i.autoEditors.length&&$(i.autoEditors).each(function(){var e=this.name,t=this.control;e&&i.data[e]&&t&&t.setValue&&t.setValue(i.data[e])}),t(a.fields),a.tab&&a.tab.items)for(var l=0;l<a.tab.items.length;l++){var r=a.tab.items[l];t(r.fields,l)}},_setValueByName:function(e,t,i){if(!e||!t)return null;if(-1==t.indexOf("."))e[t]=i;else try{new Function("data,value","data."+t+"=value;")(e,i)}catch(e){}},_getValueByName:function(e,t){if(!e||!t)return null;if(-1==t.indexOf("."))return e[t];try{return new Function("data","return data."+t+";")(e)}catch(e){return null}},valid:function(){var e=this;this.options;return!e.form||!e.validator||e.form.valid()},showFieldError:function(e,t){var i=$("[name="+e+"]",this.element);i.hasClass("l-textarea")?i.addClass("l-textarea-invalid"):i.hasClass("l-text-field")&&i.parent().addClass("l-text-invalid"),$(i).removeAttr("title").ligerHideTip(),$(i).attr("title",t).ligerTip({distanceX:5,distanceY:-3,auto:!0})},hideFieldError:function(e){var t=$("[name="+e+"]",this.element);t.hasClass("l-textarea")?t.removeClass("l-textarea-invalid"):t.parent().removeClass("l-text-invalid"),$(t).removeAttr("title").ligerHideTip()},initValidate:function(){var e=this,t=this.options;if(!e.form||!t.validate||!e.form.validate)return void(e.validator=null);var i=1==t.validate?{}:t.validate,a=$.extend({errorPlacement:function(e,t){if($(e).html()){if(!t.attr("id")){var i=(new Date).getTime();t.attr("id",i),e.attr("for",i)}t.hasClass("l-textarea")?t.addClass("l-textarea-invalid"):t.hasClass("l-text-field")&&t.parent().addClass("l-text-invalid"),$(t).removeAttr("title").ligerHideTip(),$(t).attr("title",$(e).html()).ligerTip({distanceX:5,distanceY:-3,auto:!0})}},success:function(e){var t=e.attr("for");if(t){var i=$("#"+t);i.hasClass("l-textarea")?i.removeClass("l-textarea-invalid"):i.parent().removeClass("l-text-invalid"),$(i).removeAttr("title").ligerHideTip()}}},i,{rules:e.validate.rules,messages:e.validate.messages});e.validator=e.form.validate(a)},setFieldValidate:function(e,t,i){var a=$("[name="+e+"]");if(a.length&&a.rules){var l=a.rules("remove");if(l&&(a.hasClass("l-text-field")&&a.parent().removeClass("l-text-invalid"),a.removeAttr("title").ligerHideTip(),l.required&&a.parents("li:first").next("li:first").find(".l-star").remove()),t){var r=$.extend({},t,{messages:i});a.rules("add",r),t.required&&a.parents("li:first").next("li:first").append('<span class="l-star">*</span>')}}},showInvalid:function(){var e=this,t=this.options;if(e.validator){var i=t.invalidMessage.replace("{errorCount}",e.validator.errorList.length);if(t.showInvalid)t.showInvalid(i);else{var a=$('<div><div class="invalid">'+i+'<a class="viewInvalidDetail" href="javascript:void(0)">'+t.detailMessage+'</a></div><div class="invalidDetail" style="display:none;">'+getInvalidInf(e.validator.errorList)+"</div></div>");a.find("a.viewInvalidDetail:first").bind("click",function(){$(this).parent().next("div.invalidDetail").toggle()}),$.ligerDialog.open({type:"error",width:350,showMax:!1,showToggle:!1,showMin:!1,target:a,buttons:[{text:t.okMessage,onclick:function(e,t){t.close()}}]})}}},_createEditor:function(e,t,i,a,l){var r=this.options;try{var s=e.create.call(this,t,i,r);return s&&e.resize&&e.resize.call(this,s,a,l,i),s}catch(e){return null}},_buliderLabelContainer:function(e){var t=this.options,i=e.label||e.display,a=e.labelWidth||e.labelwidth||t.labelWidth,l=e.labelAlign||t.labelAlign;if(i){var r=e.rightToken;null!=r&&""!=r||(r=t.rightToken),i+=r}var s=[];return s.push("<li"),t.labelCss&&s.push(' class="'+t.labelCss+'"'),s.push(' style="'),/px$/i.test(a)||/auto/i.test(a)||/%$/i.test(a)?s.push("width:"+a+";"):a&&s.push("width:"+a+"px;"),l&&"top"!=l&&s.push("text-align:"+l+";"),s.push('">'),i&&s.push(i),s.push("</li>"),s.join("")},_buliderControlContainer:function(e,t,i){var a=this,l=this.options,r=e.width||l.inputWidth,s=e.align||e.textAlign||e.textalign||l.align,n=[],i=i||a.id,o=e.labelAlign||l.labelAlign;return n.push("<li"),n.push(' id="'+i+"|"+t+'"'),l.fieldCss&&n.push(' class="'+l.fieldCss+'"'),n.push(' style="'),/px$/i.test(r)||/auto/i.test(r)||/%$/i.test(r)?n.push("width:"+r+";"):r&&n.push("width:"+r+"px;"),s&&n.push("text-align:"+s+";"),"top"==o&&n.push("clear:both;"),n.push('">'),n.push("</li>"),n.join("")},_buliderSpaceContainer:function(e){var t=this.options,i=e.space||e.spaceWidth||t.space;0!==e.space&&0!==e.spaceWidth||(i=0);var a=[];return a.push("<li"),t.spaceCss&&a.push(' class="'+t.spaceCss+'"'),a.push(' style="'),(/px$/i.test(i)||/auto/i.test(i)||/%$/i.test(i))&&a.push("width:"+i+";"),i&&a.push("width:"+i+"px;"),a.push('">'),e.validate&&e.validate.required&&a.push("<span class='l-star'>*</span>"),a.push("</li>"),a.join("")},_getInputAttrHtml:function(e){var t=[],i=(e.type||"text").toLowerCase();if("textarea"==i&&(e.cols&&t.push('cols="'+e.cols+'" '),e.rows&&t.push('rows="'+e.rows+'" ')),t.push('ltype="'+i+'" '),e.op&&t.push('op="'+e.op+'" '),e.vt&&t.push('vt="'+e.vt+'" '),e.attr)for(var a in e.attr)t.push(a+'="'+e.attr[a]+'" ');return t.join("")},_setTab:function(e){var t=this,i=this.options;if(e&&e.items){for(var a=$('<div class="l-form-tabs"></div>').appendTo(t.element),l=$('<ul class="'+i.clsTab+'" original-title="">').appendTo(a),r=0;r<e.items.length;r++){var s=e.items[r],n=$('<li class="'+i.clsTabItem+'"><a href="javascript:void(0)"></a></li>').appendTo(l),o=$('<div class="'+i.clsTabContent+'">').appendTo(a),d=t.id+"|tdb"+r;n.add(o).attr("data-index",r),s.id&&n.attr("data-id",s.id),n.find("a:first").text(s.title),t._initFieldsValidate({fields:s.fields}),t._initFieldsHtml({panel:o,fields:s.fields,tabindex:r,idPrev:d}),t._createEditors({fields:s.fields,idPrev:d,editPrev:"tab"+r+"_"})}l.find("li").click(function(){$(this).addClass(i.clsTabItemSelected)},function(){$(this).removeClass(i.clsTabItemSelected)}).click(function(){var e=$(this).attr("data-index");t.selectTab(e)}),t.selectTab(0)}},selectTab:function(e){var t=this,i=this.options,a=$(t.element).find(".l-form-tabs:first"),l=a.find(".ui-tabs-nav li"),r=a.find(".ui-tabs-panel");l.filter("[data-index="+e+"]").addClass(i.clsTabItemSelected),l.filter("[data-index!="+e+"]").removeClass(i.clsTabItemSelected),r.filter("[data-index="+e+"]").show(),r.filter("[data-index!="+e+"]").hide()},destroy:function(){try{var e=this;this.options;liger.remove(this);for(var t in e.editors){var i=e.editors[t].control;i&&i.destroy&&i.destroy()}$(e.element).remove()}catch(e){}}})}(jQuery);